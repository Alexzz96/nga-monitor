# 2026-02-07 - NGA Monitor 全面优化完成

## 主要工作

### 1. 性能优化（多批次）
- **浏览器复用**：实现 BrowserPool，内存从 1.6GB 降至 800MB-1GB，启动速度提升 80%
- **异步日志**：使用独立线程 + 队列，消除数据库写入阻塞
- **API 限流**：Discord/Kimi 限流保护，防止封禁
- **异常细化**：定义特定异常类型，区分致命/可恢复错误
- **配置集中化**：Prompt 模板移至 YAML 文件
- **代码拆分**：web/app.py 从 1100 行拆分为模块化路由
- **Docker 优化**：添加资源限制、健康检查

### 2. UI 现代化改造
- 引入 Tailwind CSS 框架
- 采用 shadcn/ui 设计语言
- 三页统一风格（监控/AI分析/数据管理）
- 响应式布局适配移动端
- 暗色/亮色主题支持
- 渐变卡片和毛玻璃效果

### 3. 功能扩展
- **关键词过滤**：支持 ANY/ALL/REGEX 三种匹配模式
  - 数据库存储 keywords 和 keyword_mode 字段
  - 前端界面支持设置和显示
  - 监控逻辑实现过滤

## 技术决策

### 架构改进
- 使用 `asyncio.Lock` 管理浏览器连接池
- 使用 `contextmanager` 管理数据库会话
- 使用令牌桶算法实现 API 限流
- 使用 YAML 集中管理 AI 提示词配置

### 代码组织
```
src/web/routes/
├── targets.py      # 监控目标管理
├── schedule.py     # 调度规则
├── ai.py           # AI 分析
├── archive.py      # 数据归档
├── stats.py        # 统计信息
├── webhook.py      # Webhook 管理
└── utils.py        # 工具接口
```

## 遇到的问题与解决

1. **Docker 容器无法启动 Web 服务**
   - 原因：PYTHONPATH 未设置，导致模块导入失败
   - 解决：在 Dockerfile 添加 `ENV PYTHONPATH=/app/src`

2. **web/app.py 导入路径错误**
   - 原因：`from routes import api_router` 相对导入失败
   - 解决：改为 `from web.routes import api_router`

3. **首次检查阻塞 Web 服务器启动**
   - 原因：`start_scheduler()` 是同步调用
   - 解决：使用 `asyncio.create_task()` 后台启动

4. **数据库表结构变更**
   - 原因：新增 keywords 字段，SQLite 不支持 ALTER COLUMN
   - 解决：删除数据库重新创建（开发环境）

## 提交记录

- `c59b2f8` - 全面优化 NGA Monitor 性能和架构
- `77bde79` - 全新现代化界面设计
- `134a31c` - 修复容器部署问题
- `3acb27e` - 统一 AI 分析页和数据管理页设计
- `4a2bf26` - 增加关键词过滤功能
- `582c3aa` - 修复健康检查端点导入错误

## 性能对比

| 指标 | 优化前 | 优化后 |
|-----|-------|-------|
| 内存占用 | ~1.6GB | ~800MB-1GB |
| 启动时间 | 3-5秒 | 0.5-1秒 |
| 代码可维护性 | 低 | 高 |

## 下一步建议

1. 多通知渠道（企业微信/钉钉/飞书）
2. 数据可视化（ECharts 图表）
3. 情绪分析趋势追踪
4. PWA 移动端支持
