# 2026-02-07 - NGA Monitor 开发日志

## 主要工作

### 1. 时间准确性优化
- 实现了从帖子详情页获取准确回复时间
- 添加了 `_get_accurate_post_time()` 方法
- PID 857338669 测试成功：从 13:19 修正到 13:22
- 数据库共有 972 条记录，全部有 PID

### 2. 性能优化
- 实现了"只对新回复获取准确时间"策略
- 日常监控：列表页时间（快速）→ 新回复获取准确时间
- 抓取历史：全部获取准确时间（后台运行）
- 使用全局锁 `task_lock` 防止并发冲突

### 3. 新增功能模块

#### 时间同步
- API: `POST /api/archive/sync-time`
- 前端：数据页面添加"同步时间"卡片
- 基于 PID 更新所有历史记录的时间

#### 数据清理
- API: `POST /api/archive/cleanup-user/{target_id}` - 删除指定用户数据
- API: `POST /api/archive/cleanup-all` - 删除全部数据
- 前端：三重确认保护

#### 任务清理
- API: `POST /api/archive/tasks/cleanup` - 清理卡住的任务
- API: `POST /api/archive/tasks/{task_id}/cancel` - 取消单个任务
- 前端：归档任务区域添加清理按钮和弹窗

#### 每日情绪分析
- API: `POST /api/ai/daily-sentiment/{target_id}`
- 按天分析回复情绪，生成情绪指数 (-1.0 ~ 1.0)
- 保存到 `SentimentAnalysis` 表
- 前端：AI分析页面添加模块

### 4. 前端修复
- 修复了所有页面的情绪趋势按钮
- 将完整的情绪趋势代码复制到 data.html 和 ai.html
- 修复了 HTML 结构问题（script 标签位置）

### 5. 数据库更新
- `reply_archives` 表：添加 sentiment 相关字段
- `SentimentAnalysis` 表：按日期聚合情绪数据
- `ArchiveTask` 表：任务追踪

## 关键决策

1. **PID 时间计算不可行**：PID 差值比率不稳定（11-164/minute）
2. **Docker 工作流**：宿主机修改 → git commit → docker compose up -d --build
3. **情绪分析策略**：LLM 逐天分析，而非逐条分析

## 待完成

- [ ] 测试每日情绪分析完整流程
- [ ] 验证情绪趋势图表数据展示
- [ ] 优化 AI 分析提示词

## 相关文件

- `/src/nga_crawler.py` - 爬虫核心
- `/src/ai_analyzer.py` - AI分析
- `/src/monitor.py` - 监控任务
- `/src/web/routes/archive.py` - 归档API
- `/src/web/routes/ai.py` - AI分析API
- `/src/web/templates/data.html` - 数据页面
- `/src/web/templates/ai.html` - AI分析页面
