<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGA Monitor - 数据管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer base {
            :root {
                --background: 0 0% 100%;
                --foreground: 222.2 84% 4.9%;
                --card: 0 0% 100%;
                --card-foreground: 222.2 84% 4.9%;
                --popover: 0 0% 100%;
                --popover-foreground: 222.2 84% 4.9%;
                --primary: 221.2 83.2% 53.3%;
                --primary-foreground: 210 40% 98%;
                --secondary: 210 40% 96.1%;
                --secondary-foreground: 222.2 47.4% 11.2%;
                --muted: 210 40% 96.1%;
                --muted-foreground: 215.4 16.3% 46.9%;
                --accent: 210 40% 96.1%;
                --accent-foreground: 222.2 47.4% 11.2%;
                --destructive: 0 84.2% 60.2%;
                --destructive-foreground: 210 40% 98%;
                --border: 214.3 31.8% 91.4%;
                --input: 214.3 31.8% 91.4%;
                --ring: 221.2 83.2% 53.3%;
                --radius: 0.75rem;
            }
            .dark {
                --background: 222.2 84% 4.9%;
                --foreground: 210 40% 98%;
                --card: 222.2 84% 4.9%;
                --card-foreground: 210 40% 98%;
                --popover: 222.2 84% 4.9%;
                --popover-foreground: 210 40% 98%;
                --primary: 217.2 91.2% 59.8%;
                --primary-foreground: 222.2 47.4% 11.2%;
                --secondary: 217.2 32.6% 17.5%;
                --secondary-foreground: 210 40% 98%;
                --muted: 217.2 32.6% 17.5%;
                --muted-foreground: 215 20.2% 65.1%;
                --accent: 217.2 32.6% 17.5%;
                --accent-foreground: 210 40% 98%;
                --destructive: 0 62.8% 30.6%;
                --destructive-foreground: 210 40% 98%;
                --border: 217.2 32.6% 17.5%;
                --input: 217.2 32.6% 17.5%;
                --ring: 224.3 76.3% 48%;
            }
        }
        @layer base {
            * { @apply border-border; }
            body { @apply bg-background text-foreground; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800">
    <!-- 顶部导航 -->
    <nav class="sticky top-0 z-50 w-full border-b bg-white/80 dark:bg-slate-900/80 backdrop-blur-md">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-database text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 dark:from-slate-100 dark:to-slate-300 bg-clip-text text-transparent">数据管理</h1>
                    <p class="text-xs text-muted-foreground">历史归档与数据导出</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <a href="/" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-muted-foreground hover:bg-secondary">
                    <i class="fas fa-satellite-dish mr-2"></i>监控
                </a>
                <a href="/ai" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-muted-foreground hover:bg-secondary">
                    <i class="fas fa-robot mr-2"></i>AI分析
                </a>
                <a href="/data" class="nav-btn active px-4 py-2 rounded-lg text-sm font-medium transition-all bg-primary text-primary-foreground shadow-md">
                    <i class="fas fa-database mr-2"></i>数据
                </a>
            </div>
        </div>
    </nav>

    <!-- 左侧悬浮导航 - 数据页面 -->
    <div class="fixed left-4 top-1/2 -translate-y-1/2 z-40 flex flex-col gap-2 bg-card/90 backdrop-blur rounded-xl shadow-lg border p-2">
        <a href="/" class="w-10 h-10 rounded-lg hover:bg-muted flex items-center justify-center text-muted-foreground transition-all" title="监控">
            <i class="fas fa-satellite-dish"></i>
        </a>
        <a href="/ai" class="w-10 h-10 rounded-lg hover:bg-muted flex items-center justify-center text-muted-foreground transition-all" title="AI分析">
            <i class="fas fa-robot"></i>
        </a>
        <a href="/data" class="w-10 h-10 rounded-lg bg-primary text-primary-foreground flex items-center justify-center transition-all shadow-md" title="数据">
            <i class="fas fa-database"></i>
        </a>
    </div>

    <main class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- 提示框 -->
        <div id="alert" class="hidden fixed top-20 right-4 z-50 max-w-md"></div>

        <!-- 统计概览 -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <i class="fas fa-chart-pie text-primary"></i>
                数据概览
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4" id="stats-overview">
                <!-- 动态加载 -->
            </div>
        </section>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- 左侧：用户数据 -->
            <div class="xl:col-span-2 space-y-6">
                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-card to-muted/30">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <h2 class="text-xl font-semibold flex items-center gap-2">
                                <i class="fas fa-users text-primary"></i>
                                用户数据
                            </h2>
                            <div class="flex gap-2">
                                <select id="target-select" onchange="loadTargetHistory()" class="px-3 py-2 rounded-lg border bg-background text-sm">
                                    <option value="">选择用户</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="target-stats" class="p-6">
                        <div class="text-center py-12 text-muted-foreground">
                            <i class="fas fa-arrow-up text-4xl mb-4 opacity-50"></i>
                            <p>请选择用户查看数据</p>
                        </div>
                    </div>
                </section>

                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-card to-muted/30">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-semibold flex items-center gap-2">
                                <i class="fas fa-history text-primary"></i>
                                历史回复
                            </h2>
                            <div class="flex gap-2">
                                <button onclick="loadTargetHistory()" class="p-2 rounded-lg border hover:bg-muted transition-all">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="history-list" class="p-6">
                        <div class="text-center py-12 text-muted-foreground">
                            <i class="fas fa-inbox text-4xl mb-4 opacity-50"></i>
                            <p>暂无数据</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- 右侧：归档任务与操作 -->
            <div class="space-y-6">
                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-green-500/10 to-emerald-500/10">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-cloud-download-alt text-green-500"></i>
                            抓取历史
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="text-sm font-medium">选择用户</label>
                            <select id="archive-target" class="w-full mt-1 px-3 py-2 rounded-lg border bg-background">
                                <option value="">请选择</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium">抓取页数（每页约20条）</label>
                            <input type="number" id="archive-pages" value="10" min="1" max="25"
                                   class="w-full mt-1 px-3 py-2 rounded-lg border bg-background">
                        </div>
                        <button onclick="startArchive()" class="w-full px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                            <i class="fas fa-play mr-2"></i>开始抓取
                        </button>
                    </div>
                </section>

                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-tasks text-blue-500"></i>
                            归档任务
                        </h2>
                    </div>
                    <div id="archive-tasks" class="p-6">
                        <!-- 动态加载 -->
                    </div>
                </section>

                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-orange-500/10 to-red-500/10">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-broom text-orange-500"></i>
                            数据清理
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="p-4 rounded-xl bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-exclamation-triangle text-orange-500 mt-0.5"></i>
                                <div class="text-sm">
                                    <p class="font-medium text-orange-700 dark:text-orange-400">谨慎操作</p>
                                    <p class="text-orange-600 dark:text-orange-300 mt-1">清理后将永久删除数据，不可恢复</p>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-sm font-medium">保留天数</label>
                            <select id="cleanup-days" class="w-full mt-1 px-3 py-2 rounded-lg border bg-background">
                                <option value="30">保留最近 30 天</option>
                                <option value="90">保留最近 90 天</option>
                                <option value="180">保留最近 180 天</option>
                                <option value="365">保留最近 365 天</option>
                            </select>
                        </div>
                        <button onclick="cleanupArchive()" class="w-full px-4 py-2 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                            <i class="fas fa-trash-alt mr-2"></i>清理旧数据
                        </button>
                    </div>
                </section>

                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-purple-500/10 to-pink-500/10">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-file-export text-purple-500"></i>
                            数据导出
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="text-sm font-medium">选择用户</label>
                            <select id="export-target" class="w-full mt-1 px-3 py-2 rounded-lg border bg-background">
                                <option value="">请选择</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium">导出范围</label>
                            <select id="export-days" class="w-full mt-1 px-3 py-2 rounded-lg border bg-background">
                                <option value="">全部数据</option>
                                <option value="30">最近 30 天</option>
                                <option value="90">最近 90 天</option>
                                <option value="365">最近 365 天</option>
                            </select>
                        </div>
                        <button onclick="exportData()" class="w-full px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                            <i class="fas fa-download mr-2"></i>导出 JSON
                        </button>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script>
        // 显示提示
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500'
            };
            alert.innerHTML = `
                <div class="${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-2 animate-in slide-in-from-right">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            alert.classList.remove('hidden');
            setTimeout(() => alert.classList.add('hidden'), 5000);
        }

        // 加载概览统计
        async function loadOverview() {
            try {
                const res = await fetch('/api/archive/stats');
                const data = await res.json();
                
                document.getElementById('stats-overview').innerHTML = `
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm">总存档数</p>
                                <p class="text-3xl font-bold mt-1">${data.total_archived}</p>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
                                <i class="fas fa-archive text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm">监控用户</p>
                                <p class="text-3xl font-bold mt-1">${data.user_stats.filter(u => u.count > 0).length}</p>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
                                <i class="fas fa-users text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm">数据库大小</p>
                                <p class="text-3xl font-bold mt-1">${(data.db_size / 1024 / 1024).toFixed(1)} MB</p>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
                                <i class="fas fa-database text-xl"></i>
                            </div>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('加载概览失败:', e);
            }
        }

        // 加载用户列表
        async function loadTargets() {
            try {
                const res = await fetch('/api/targets');
                const data = await res.json();
                
                const options = data.targets.map(t => `<option value="${t.id}">${t.name || t.uid}</option>`).join('');
                
                document.getElementById('target-select').innerHTML = '<option value="">选择用户</option>' + options;
                document.getElementById('archive-target').innerHTML = '<option value="">请选择</option>' + options;
                document.getElementById('export-target').innerHTML = '<option value="">请选择</option>' + options;
            } catch (e) {
                console.error('加载用户失败:', e);
            }
        }

        // 辅助函数：安全解析日期
        function safeFormatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                // 处理 "26-01-12 09:05" 格式 -> "2026-01-12T09:05:00"
                const match = dateStr.match(/(\d{2})-(\d{2})-(\d{2})(?:\s+(\d{2}):(\d{2}))?/);
                if (match) {
                    const [_, year, month, day, hour = '00', minute = '00'] = match;
                    const fullYear = '20' + year;
                    const isoStr = `${fullYear}-${month}-${day}T${hour}:${minute}:00`;
                    return new Date(isoStr).toLocaleDateString('zh-CN');
                }
                return new Date(dateStr).toLocaleDateString('zh-CN');
            } catch (e) {
                return dateStr; // 返回原始字符串
            }
        }

        // 加载用户历史
        async function loadTargetHistory() {
            const targetId = document.getElementById('target-select').value;
            if (!targetId) return;
            
            try {
                // 加载统计
                const statsRes = await fetch(`/api/archive/status/${targetId}`);
                if (!statsRes.ok) {
                    throw new Error(`API错误: ${statsRes.status}`);
                }
                const stats = await statsRes.json();
                
                document.getElementById('target-stats').innerHTML = `
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                        <div class="p-4 rounded-xl bg-muted/50 text-center">
                            <p class="text-2xl font-bold text-primary">${stats.total_archived || 0}</p>
                            <p class="text-sm text-muted-foreground">总存档</p>
                        </div>
                        <div class="p-4 rounded-xl bg-muted/50 text-center">
                            <p class="text-2xl font-bold text-primary">${safeFormatDate(stats.latest_post_date)}</p>
                            <p class="text-sm text-muted-foreground">最新</p>
                        </div>
                        <div class="p-4 rounded-xl bg-muted/50 text-center">
                            <p class="text-2xl font-bold text-primary">${safeFormatDate(stats.earliest_post_date)}</p>
                            <p class="text-sm text-muted-foreground">最早</p>
                        </div>
                        <div class="p-4 rounded-xl bg-muted/50 text-center">
                            <p class="text-2xl font-bold ${stats.running_task ? 'text-orange-500' : 'text-green-500'}">${stats.running_task ? '进行中' : '空闲'}</p>
                            <p class="text-sm text-muted-foreground">状态</p>
                        </div>
                    </div>
                `;
                
                // 加载历史列表（支持分页）
                await loadHistoryPage(targetId, 1);
            } catch (e) {
                console.error('加载历史失败:', e);
                document.getElementById('target-stats').innerHTML = `
                    <div class="p-4 rounded-xl bg-red-50 text-red-600 text-center">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>加载失败: ${e.message}</p>
                    </div>
                `;
            }
        }

        // 当前页码缓存
        let currentHistoryPage = 1;
        let currentHistoryTargetId = null;

        // 加载历史分页数据
        async function loadHistoryPage(targetId, page) {
            currentHistoryTargetId = targetId;
            currentHistoryPage = page;
            
            try {
                const historyRes = await fetch(`/api/archive/history/${targetId}?page=${page}&limit=20`);
                if (!historyRes.ok) {
                    throw new Error(`API错误: ${historyRes.status}`);
                }
                const history = await historyRes.json();
                
                if (!history.records || history.records.length === 0) {
                    document.getElementById('history-list').innerHTML = `
                        <div class="text-center py-12 text-muted-foreground">
                            <i class="fas fa-inbox text-4xl mb-4 opacity-50"></i>
                            <p>暂无历史数据</p>
                        </div>
                    `;
                    return;
                }
                
                const totalPages = Math.ceil(history.total / history.limit);
                
                document.getElementById('history-list').innerHTML = `
                    <div class="space-y-3">
                        ${history.records.map(r => `
                            <div class="p-4 rounded-xl border hover:bg-muted/50 transition-all">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-foreground line-clamp-3">${r.main_content || r.content_full || '无内容'}</p>
                                        <div class="flex items-center gap-2 mt-2 text-xs text-muted-foreground">
                                            <span class="bg-muted px-2 py-0.5 rounded">${r.post_date || '-'}</span>
                                            <span>${r.forum || '未知版块'}</span>
                                            <span class="truncate max-w-[200px]" title="${r.topic_title || ''}">主题: ${r.topic_title || '无标题'}</span>
                                        </div>
                                    </div>
                                    <a href="${r.url}" target="_blank" class="p-2 rounded-lg hover:bg-primary/10 text-primary transition-all flex-shrink-0" title="查看原帖">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- 分页控制 -->
                    <div class="flex items-center justify-between mt-6 pt-4 border-t">
                        <div class="text-sm text-muted-foreground">
                            共 ${history.total} 条 · 第 ${history.page}/${totalPages} 页
                        </div>
                        <div class="flex gap-2">
                            <button 
                                onclick="loadHistoryPage(${targetId}, ${page - 1})" 
                                class="px-3 py-1.5 rounded-lg border hover:bg-muted transition-all text-sm ${page <= 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${page <= 1 ? 'disabled' : ''}>
                                <i class="fas fa-chevron-left mr-1"></i>上一页
                            </button>
                            <button 
                                onclick="loadHistoryPage(${targetId}, ${page + 1})" 
                                class="px-3 py-1.5 rounded-lg border hover:bg-muted transition-all text-sm ${page >= totalPages ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${page >= totalPages ? 'disabled' : ''}>
                                下一页<i class="fas fa-chevron-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('加载历史分页失败:', e);
                document.getElementById('history-list').innerHTML = `
                    <div class="text-center py-12 text-muted-foreground">
                        <i class="fas fa-exclamation-circle text-4xl mb-4 opacity-50"></i>
                        <p>加载失败: ${e.message}</p>
                    </div>
                `;
            }
        }

        // 加载归档任务
        async function loadArchiveTasks() {
            try {
                const res = await fetch('/api/archive/tasks');
                const data = await res.json();
                
                if (!data.tasks || data.tasks.length === 0) {
                    document.getElementById('archive-tasks').innerHTML = `
                        <div class="text-center py-8 text-muted-foreground">
                            <i class="fas fa-clipboard-list text-3xl mb-2 opacity-50"></i>
                            <p class="text-sm">暂无任务</p>
                        </div>
                    `;
                    return;
                }
                
                document.getElementById('archive-tasks').innerHTML = data.tasks.slice(0, 5).map(t => `
                    <div class="p-4 rounded-xl border ${t.status === 'running' ? 'bg-orange-50 dark:bg-orange-900/20 border-orange-200' : t.status === 'completed' ? 'bg-green-50 dark:bg-green-900/20 border-green-200' : 'bg-red-50 dark:bg-red-900/20 border-red-200'}">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-medium px-2 py-0.5 rounded-full ${t.status === 'running' ? 'bg-orange-100 text-orange-700' : t.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                        ${t.status === 'running' ? '进行中' : t.status === 'completed' ? '已完成' : '失败'}
                                    </span>
                                    <span class="text-sm font-medium">${t.target_name}</span>
                                </div>
                                ${t.status === 'running' ? `
                                    <div class="mt-2">
                                        <div class="h-2 rounded-full bg-muted overflow-hidden">
                                            <div class="h-full bg-orange-500 transition-all" style="width: ${(t.completed_pages / t.total_pages * 100)}%"></div>
                                        </div>
                                        <p class="text-xs text-muted-foreground mt-1">${t.completed_pages}/${t.total_pages} 页 · ${t.total_replies} 条回复</p>
                                    </div>
                                ` : `
                                    <p class="text-xs text-muted-foreground mt-1">${t.archived_count || 0} 条已存档</p>
                                `}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('加载任务失败:', e);
            }
        }

        // 开始归档
        async function startArchive() {
            const targetId = document.getElementById('archive-target').value;
            const pages = parseInt(document.getElementById('archive-pages').value) || 10;
            
            if (!targetId) {
                showAlert('请选择用户', 'error');
                return;
            }
            
            try {
                showAlert('已开始抓取历史数据', 'warning');
                
                const res = await fetch(`/api/archive/history/${targetId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({max_pages: pages})
                });
                
                if (res.ok) {
                    const data = await res.json();
                    showAlert(data.message);
                    loadArchiveTasks();
                } else {
                    const err = await res.json();
                    showAlert(err.detail || '启动失败', 'error');
                }
            } catch (e) {
                showAlert('请求失败', 'error');
            }
        }

        // 清理数据
        async function cleanupArchive() {
            const days = parseInt(document.getElementById('cleanup-days').value);
            
            if (!confirm(`确定要清理 ${days} 天前的数据吗？\n此操作不可恢复！`)) {
                return;
            }
            
            try {
                showAlert('正在清理...', 'warning');
                
                const res = await fetch('/api/archive/cleanup', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({days, dry_run: false})
                });
                
                if (res.ok) {
                    const data = await res.json();
                    showAlert(`已清理 ${data.deleted} 条数据`);
                    loadOverview();
                    loadTargetHistory();
                } else {
                    showAlert('清理失败', 'error');
                }
            } catch (e) {
                showAlert('请求失败', 'error');
            }
        }

        // 导出数据
        async function exportData() {
            const targetId = document.getElementById('export-target').value;
            const days = document.getElementById('export-days').value;
            
            if (!targetId) {
                showAlert('请选择用户', 'error');
                return;
            }
            
            try {
                showAlert('正在导出...', 'warning');
                
                const res = await fetch(`/api/archive/export/${targetId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({days: days ? parseInt(days) : null})
                });
                
                if (res.ok) {
                    const data = await res.json();
                    
                    // 创建下载
                    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `nga_export_${targetId}_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    showAlert('导出成功');
                } else {
                    showAlert('导出失败', 'error');
                }
            } catch (e) {
                showAlert('请求失败', 'error');
            }
        }

        // 页面加载
        document.addEventListener('DOMContentLoaded', function() {
            loadOverview();
            loadTargets();
            loadArchiveTasks();
            
            // 定时刷新任务状态
            setInterval(loadArchiveTasks, 10000);
        });
    </script>
</body>
</html>
