<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGA Monitor - æ•°æ®ç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .nav {
            margin-bottom: 20px;
        }
        .nav a {
            color: #3498db;
            text-decoration: none;
            margin-right: 0;
        }
        .nav-btn {
            padding: 8px 16px;
            border-radius: 4px;
            background: #f8f9fa;
            color: #555;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
        }
        .nav-btn:hover {
            background: #e9ecef;
        }
        .nav-btn.active {
            background: #3498db;
            color: white;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #34495e;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            font-weight: 600;
            color: #555;
            background: #f8f9fa;
        }
        tr:hover { background: #f8f9fa; }
        .badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        select, input[type="text"], input[type="number"] {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;
        }
        select:focus, input:focus { outline: none; border-color: #3498db; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .checkbox-item {
            display: flex; align-items: center; gap: 5px;
            padding: 8px 12px; background: #f8f9fa; border-radius: 4px; cursor: pointer;
        }
        .checkbox-item:hover { background: #e9ecef; }
        .checkbox-item input { cursor: pointer; }
        .alert {
            padding: 12px 15px; border-radius: 4px; margin-bottom: 15px;
        }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .hidden { display: none !important; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        .progress-bar {
            background: #e9ecef;
            border-radius: 4px;
            height: 20px;
            overflow: hidden;
        }
        .progress-fill {
            background: #3498db;
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow: auto;
            width: 90%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š æ•°æ®ç®¡ç†ä¸­å¿ƒ</h1>
        
        <div class="nav" style="display: flex; gap: 10px;">
            <a href="/" class="nav-btn">ğŸ“¡ ç›‘æ§ç®¡ç†</a>
            <a href="/ai" class="nav-btn">ğŸ¤– AI åˆ†æ</a>
            <a href="/data" class="nav-btn active">ğŸ“Š æ•°æ®ç®¡ç†</a>
        </div>
        
        <!-- æ€»ä½“ç»Ÿè®¡ -->
        <div class="card">
            <h2>ğŸ“ˆ æ€»ä½“ç»Ÿè®¡</h2>
            <div class="stats-grid" id="overall-stats">
                <div class="stat-card">
                    <div class="stat-value" id="total-targets">-</div>
                    <div class="stat-label">ç›‘æ§ç›®æ ‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-archived">-</div>
                    <div class="stat-label">å·²å­˜æ¡£å›å¤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-sent">-</div>
                    <div class="stat-label">å·²æ¨é€æ¶ˆæ¯</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="db-size">-</div>
                    <div class="stat-label">æ•°æ®åº“å¤§å°</div>
                </div>
            </div>
        </div>
        
        <!-- å†å²æ•°æ®å½’æ¡£ -->
        <div class="card">
            <h2>ğŸ“¥ å†å²æ•°æ®å½’æ¡£</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">æŠ“å–ç”¨æˆ·çš„å†å²å›å¤å¹¶å­˜æ¡£ï¼Œç”¨äº AI åˆ†æã€‚æ¯é¡µçº¦ 20 æ¡å›å¤ã€‚</p>
            
            <div class="form-group">
                <label>é€‰æ‹©è¦å½’æ¡£çš„ç”¨æˆ·</label>
                <div class="checkbox-group" id="archive-targets">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="form-group">
                <label>æŠ“å–é¡µæ•°ï¼ˆæ¯é¡µçº¦20æ¡ï¼‰</label>
                <select id="archive-pages">
                    <option value="10">10é¡µï¼ˆçº¦200æ¡ï¼‰</option>
                    <option value="25" selected>25é¡µï¼ˆçº¦500æ¡ï¼‰</option>
                    <option value="50">50é¡µï¼ˆçº¦1000æ¡ï¼‰</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="startArchive()">å¼€å§‹æŠ“å–å†å²</button>
                <button class="btn btn-secondary" onclick="loadArchiveStatus()">æŸ¥çœ‹å½’æ¡£çŠ¶æ€</button>
            </div>
            
            <div id="archive-status" style="margin-top: 15px;"></div>
        </div>
        
        <!-- ç”¨æˆ·å½’æ¡£è¯¦æƒ… -->
        <div class="card">
            <h2>ğŸ‘¤ ç”¨æˆ·å½’æ¡£è¯¦æƒ…</h2>
            <table>
                <thead>
                    <tr>
                        <th>ç”¨æˆ·</th>
                        <th>UID</th>
                        <th>çŠ¶æ€</th>
                        <th>å·²å­˜æ¡£</th>
                        <th>å·²æ¨é€</th>
                        <th>æ—¶é—´èŒƒå›´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="users-table">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
        
        <!-- æ•°æ®åº“æ¸…ç† -->
        <div class="card">
            <h2>ğŸ§¹ æ•°æ®åº“æ¸…ç†</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">åˆ é™¤æ—§çš„å½’æ¡£æ•°æ®ä»¥é‡Šæ”¾ç©ºé—´ã€‚</p>
            
            <div class="form-group">
                <label>ä¿ç•™æœ€è¿‘ N å¤©çš„æ•°æ®</label>
                <div style="display: flex; gap: 10px;">
                    <select id="cleanup-days" style="width: 150px;">
                        <option value="30">30 å¤©</option>
                        <option value="60">60 å¤©</option>
                        <option value="90" selected>90 å¤©</option>
                        <option value="180">180 å¤©</option>
                    </select>
                    <button class="btn btn-secondary" onclick="previewCleanup()">é¢„è§ˆ</button>
                    <button class="btn btn-warning" onclick="executeCleanup()" id="cleanup-btn" style="display: none;">ç¡®è®¤åˆ é™¤</button>
                </div>
            </div>
            
            <div id="cleanup-preview"></div>
        </div>
        
        <!-- å½’æ¡£ä»»åŠ¡ -->
        <div class="card">
            <h2>â³ è¿‘æœŸå½’æ¡£ä»»åŠ¡</h2>
            <table>
                <thead>
                    <tr>
                        <th>ç”¨æˆ·</th>
                        <th>çŠ¶æ€</th>
                        <th>è¿›åº¦</th>
                        <th>æŠ“å–/å­˜æ¡£</th>
                        <th>å¼€å§‹æ—¶é—´</th>
                    </tr>
                </thead>
                <tbody id="tasks-table">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- ç”¨æˆ·è¯¦æƒ…å¼¹çª— -->
    <div class="modal" id="user-modal">
        <div class="modal-content">
            <h3 id="modal-title">ç”¨æˆ·è¯¦æƒ…</h3>
            <div id="modal-content"></div>
            <button class="btn btn-secondary" onclick="closeModal()" style="margin-top: 15px;">å…³é—­</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadOverallStats();
            loadUsersDetail();
            loadRecentTasks();
        });
        
        // æ€»ä½“ç»Ÿè®¡
        async function loadOverallStats() {
            try {
                const [statsRes, archiveRes] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/archive/stats')
                ]);
                
                const stats = await statsRes.json();
                const archive = await archiveRes.json();
                
                document.getElementById('total-targets').textContent = stats.targets.total;
                document.getElementById('total-sent').textContent = stats.sent.total;
                document.getElementById('total-archived').textContent = archive.total_archived || 0;
                document.getElementById('db-size').textContent = formatBytes(archive.db_size || 0);
            } catch (e) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', e);
            }
        }
        
        // ç”¨æˆ·è¯¦æƒ…
        async function loadUsersDetail() {
            try {
                const res = await fetch('/api/targets');
                const data = await res.json();
                
                const tbody = document.getElementById('users-table');
                const archiveContainer = document.getElementById('archive-targets');
                tbody.innerHTML = '';
                archiveContainer.innerHTML = '';
                
                for (const target of data.targets) {
                    // è·å–æ¯ä¸ªç”¨æˆ·çš„å½’æ¡£çŠ¶æ€
                    const archiveRes = await fetch(`/api/archive/status/${target.id}`);
                    const archive = await archiveRes.json();
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${target.name || '-'}</strong></td>
                        <td>${target.uid}</td>
                        <td>
                            <span class="badge ${target.enabled ? 'badge-success' : 'badge-warning'}">
                                ${target.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                            </span>
                        </td>
                        <td>${archive.total_archived || 0}</td>
                        <td>-</td>
                        <td>
                            ${archive.earliest_post_date || '-'}<br>
                            ~ ${archive.latest_post_date || '-'}
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="viewUserDetail(${target.id})">æŸ¥çœ‹å†å²</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                    
                    // å½’æ¡£ç›®æ ‡é€‰æ‹©
                    const label = document.createElement('label');
                    label.className = 'checkbox-item';
                    label.innerHTML = `
                        <input type="radio" name="archive-target" value="${target.id}" data-name="${target.name}">
                        <span>${target.name || target.uid}</span>
                    `;
                    archiveContainer.appendChild(label);
                }
            } catch (e) {
                console.error('åŠ è½½ç”¨æˆ·è¯¦æƒ…å¤±è´¥:', e);
            }
        }
        
        // å†å²å½’æ¡£åŠŸèƒ½
        async function startArchive() {
            const selected = document.querySelector('input[name="archive-target"]:checked');
            if (!selected) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªè¦å½’æ¡£çš„ç”¨æˆ·');
                return;
            }
            
            const targetId = parseInt(selected.value);
            const maxPages = parseInt(document.getElementById('archive-pages').value);
            
            if (!confirm(`ç¡®å®šè¦æŠ“å– ${maxPages} é¡µå†å²æ•°æ®å—ï¼Ÿè¿™å°†è€—æ—¶çº¦ ${maxPages * 2} ç§’ã€‚`)) {
                return;
            }
            
            document.getElementById('archive-status').innerHTML = `
                <div class="alert alert-info">
                    <strong>â³ æŠ“å–è¿›è¡Œä¸­...</strong><br>
                    æ­£åœ¨åå°æŠ“å– ${maxPages} é¡µå†å²æ•°æ®ã€‚<br>
                    æ¯é¡µé—´éš” 2 ç§’ï¼Œé¢„è®¡è€—æ—¶ ${maxPages * 2} ç§’ã€‚
                </div>
            `;
            
            try {
                const res = await fetch(`/api/archive/history/${targetId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({max_pages: maxPages})
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    setTimeout(loadArchiveStatus, 1000);
                } else {
                    alert(data.detail || 'å¯åŠ¨å¤±è´¥');
                    document.getElementById('archive-status').innerHTML = '';
                }
            } catch (e) {
                alert('è¯·æ±‚å¤±è´¥');
                document.getElementById('archive-status').innerHTML = '';
            }
        }
        
        async function loadArchiveStatus() {
            const selected = document.querySelector('input[name="archive-target"]:checked');
            if (!selected) {
                document.getElementById('archive-status').innerHTML = '<p style="color: #666;">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç”¨æˆ·</p>';
                return;
            }
            
            const targetId = parseInt(selected.value);
            
            try {
                const res = await fetch(`/api/archive/status/${targetId}`);
                const data = await res.json();
                
                if (res.ok) {
                    let html = `
                        <div class="alert alert-success">
                            <strong>ğŸ“Š ${data.target_name} çš„å½’æ¡£çŠ¶æ€</strong><br>
                            å·²å­˜æ¡£: <strong>${data.total_archived}</strong> æ¡å›å¤<br>
                            æœ€æ–°å›å¤: ${data.latest_post_date || 'æ— '}<br>
                            æœ€æ—©å›å¤: ${data.earliest_post_date || 'æ— '}
                    `;
                    
                    if (data.running_task) {
                        const progress = data.running_task.progress_percent;
                        html += `
                            <hr style="margin: 10px 0;">
                            <strong>â³ æ­£åœ¨æŠ“å–ä¸­...</strong><br>
                            è¿›åº¦: ${data.running_task.completed_pages}/${data.running_task.total_pages} é¡µ (${progress}%)<br>
                            å·²è·å–: ${data.running_task.total_replies} æ¡å›å¤<br>
                            <div class="progress-bar" style="margin-top: 5px;">
                                <div class="progress-fill" style="width: ${progress}%;"></div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    document.getElementById('archive-status').innerHTML = html;
                    
                    if (data.running_task) {
                        setTimeout(loadArchiveStatus, 1000);
                    }
                }
            } catch (e) {
                console.error('è·å–çŠ¶æ€å¤±è´¥:', e);
            }
        }
        
        // è¿‘æœŸä»»åŠ¡
        async function loadRecentTasks() {
            try {
                const res = await fetch('/api/archive/tasks?limit=10');
                const data = await res.json();
                
                const tbody = document.getElementById('tasks-table');
                tbody.innerHTML = '';
                
                if (data.tasks.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">æš‚æ— ä»»åŠ¡</td></tr>';
                    return;
                }
                
                for (const task of data.tasks) {
                    const row = document.createElement('tr');
                    const statusBadge = {
                        'running': '<span class="badge badge-success">è¿›è¡Œä¸­</span>',
                        'completed': '<span class="badge badge-success">å·²å®Œæˆ</span>',
                        'failed': '<span class="badge badge-warning">å¤±è´¥</span>',
                        'pending': '<span class="badge badge-warning">ç­‰å¾…ä¸­</span>'
                    }[task.status] || task.status;
                    
                    row.innerHTML = `
                        <td>${task.target_name || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${task.progress_percent}%"></div>
                            </div>
                            ${task.progress_percent}%
                        </td>
                        <td>${task.total_replies} / ${task.archived_count}</td>
                        <td>${new Date(task.started_at).toLocaleString()}</td>
                    `;
                    tbody.appendChild(row);
                }
                
                // å¦‚æœæœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡ï¼Œè‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯ç§’ï¼‰
                if (data.tasks.some(t => t.status === 'running')) {
                    setTimeout(loadRecentTasks, 1000);
                }
            } catch (e) {
                console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', e);
            }
        }
        
        // æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…ï¼ˆæ˜¾ç¤ºå†å²å›å¤åˆ—è¡¨ï¼‰
        let currentHistoryPage = 1;
        let currentTargetId = null;
        
        async function viewUserDetail(targetId) {
            currentTargetId = targetId;
            currentHistoryPage = 1;
            
            try {
                const [targetRes, archiveRes] = await Promise.all([
                    fetch(`/api/targets`),
                    fetch(`/api/archive/status/${targetId}`)
                ]);
                
                const targets = await targetRes.json();
                const archive = await archiveRes.json();
                const target = targets.targets.find(t => t.id === targetId);
                
                document.getElementById('modal-title').textContent = `${target.name} çš„å†å²å›å¤`;
                document.getElementById('modal-content').innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <p><strong>UID:</strong> ${target.uid} | <strong>å·²å­˜æ¡£:</strong> ${archive.total_archived} æ¡</p>
                    </div>
                    <div id="history-list" style="max-height: 400px; overflow-y: auto;">
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                    <div id="history-pagination" style="margin-top: 15px; text-align: center;">
                    </div>
                `;
                
                document.getElementById('user-modal').classList.add('active');
                await loadUserHistory(targetId, 1);
            } catch (e) {
                console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', e);
            }
        }
        
        async function loadUserHistory(targetId, page) {
            currentHistoryPage = page;
            const limit = 10;
            
            try {
                const res = await fetch(`/api/archive/history/${targetId}?page=${page}&limit=${limit}`);
                const data = await res.json();
                
                if (!res.ok) {
                    document.getElementById('history-list').innerHTML = `<p style="color: #e74c3c;">åŠ è½½å¤±è´¥: ${data.detail}</p>`;
                    return;
                }
                
                const historyList = document.getElementById('history-list');
                
                if (data.records.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— å†å²å›å¤</p>';
                    return;
                }
                
                let html = '';
                for (const record of data.records) {
                    html += `
                        <div style="border: 1px solid #eee; border-radius: 4px; padding: 12px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <a href="${record.url}" target="_blank" style="color: #3498db; font-weight: bold; text-decoration: none;">
                                    ğŸ“Œ ${record.topic_title || 'æ— æ ‡é¢˜'}
                                </a>
                                <span style="color: #666; font-size: 12px;">${record.post_date || '-'}</span>
                            </div>
                            ${record.quote_content ? `<div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 8px; font-size: 13px; color: #666;">
                                <em>å¼•ç”¨: ${record.quote_content.substring(0, 100)}${record.quote_content.length > 100 ? '...' : ''}</em>
                            </div>` : ''}
                            <div style="font-size: 14px; line-height: 1.6;">${record.main_content || record.content_full || 'æ— å†…å®¹'}</div>
                            <div style="margin-top: 8px; font-size: 12px; color: #999;">
                                PID: ${record.pid} | ç‰ˆå—: ${record.forum || '-'}
                            </div>
                        </div>
                    `;
                }
                historyList.innerHTML = html;
                
                // åˆ†é¡µ
                const totalPages = Math.ceil(data.total / limit);
                let paginationHtml = '';
                if (totalPages > 1) {
                    paginationHtml += `
                        <button class="btn btn-sm ${page === 1 ? 'btn-secondary' : 'btn-primary'}" 
                            onclick="loadUserHistory(${targetId}, ${page - 1})" 
                            ${page === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                        <span style="margin: 0 10px;">${page} / ${totalPages}</span>
                        <button class="btn btn-sm ${page === totalPages ? 'btn-secondary' : 'btn-primary'}" 
                            onclick="loadUserHistory(${targetId}, ${page + 1})" 
                            ${page === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
                    `;
                }
                document.getElementById('history-pagination').innerHTML = paginationHtml;
                
            } catch (e) {
                document.getElementById('history-list').innerHTML = `<p style="color: #e74c3c;">åŠ è½½å¤±è´¥: ${e.message}</p>`;
            }
        }
        
        function closeModal() {
            document.getElementById('user-modal').classList.remove('active');
        }
        
        // æ•°æ®åº“æ¸…ç†
        let cleanupPreviewData = null;
        
        async function previewCleanup() {
            const days = parseInt(document.getElementById('cleanup-days').value);
            
            try {
                const res = await fetch('/api/archive/cleanup', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({days: days, dry_run: true})
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    cleanupPreviewData = {days, would_delete: data.would_delete};
                    
                    document.getElementById('cleanup-preview').innerHTML = `
                        <div class="alert alert-info">
                            <strong>ğŸ“‹ æ¸…ç†é¢„è§ˆ</strong><br>
                            å°†åˆ é™¤ <strong>${data.would_delete}</strong> æ¡è®°å½•ï¼ˆ${days} å¤©å‰ï¼‰<br>
                            æˆªæ­¢æ—¶é—´: ${new Date(data.cutoff_date).toLocaleString()}
                        </div>
                    `;
                    
                    document.getElementById('cleanup-btn').style.display = 'inline-block';
                } else {
                    alert(data.detail || 'é¢„è§ˆå¤±è´¥');
                }
            } catch (e) {
                alert('è¯·æ±‚å¤±è´¥');
            }
        }
        
        async function executeCleanup() {
            if (!cleanupPreviewData) {
                alert('è¯·å…ˆé¢„è§ˆ');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${cleanupPreviewData.would_delete} æ¡æ—§è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            
            try {
                const res = await fetch('/api/archive/cleanup', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({days: cleanupPreviewData.days, dry_run: false})
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    alert(`å·²åˆ é™¤ ${data.deleted} æ¡æ—§è®°å½•`);
                    document.getElementById('cleanup-preview').innerHTML = `
                        <div class="alert alert-success">
                            <strong>âœ… æ¸…ç†å®Œæˆ</strong><br>
                            å·²åˆ é™¤ ${data.deleted} æ¡è®°å½•
                        </div>
                    `;
                    document.getElementById('cleanup-btn').style.display = 'none';
                    cleanupPreviewData = null;
                    loadOverallStats();
                } else {
                    alert(data.detail || 'æ¸…ç†å¤±è´¥');
                }
            } catch (e) {
                alert('è¯·æ±‚å¤±è´¥');
            }
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('user-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    </script>
</body>
</html>
