<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGA Monitor - 监控管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer base {
            :root {
                --background: 0 0% 100%;
                --foreground: 222.2 84% 4.9%;
                --card: 0 0% 100%;
                --card-foreground: 222.2 84% 4.9%;
                --popover: 0 0% 100%;
                --popover-foreground: 222.2 84% 4.9%;
                --primary: 221.2 83.2% 53.3%;
                --primary-foreground: 210 40% 98%;
                --secondary: 210 40% 96.1%;
                --secondary-foreground: 222.2 47.4% 11.2%;
                --muted: 210 40% 96.1%;
                --muted-foreground: 215.4 16.3% 46.9%;
                --accent: 210 40% 96.1%;
                --accent-foreground: 222.2 47.4% 11.2%;
                --destructive: 0 84.2% 60.2%;
                --destructive-foreground: 210 40% 98%;
                --border: 214.3 31.8% 91.4%;
                --input: 214.3 31.8% 91.4%;
                --ring: 221.2 83.2% 53.3%;
                --radius: 0.75rem;
            }
            .dark {
                --background: 222.2 84% 4.9%;
                --foreground: 210 40% 98%;
                --card: 222.2 84% 4.9%;
                --card-foreground: 210 40% 98%;
                --popover: 222.2 84% 4.9%;
                --popover-foreground: 210 40% 98%;
                --primary: 217.2 91.2% 59.8%;
                --primary-foreground: 222.2 47.4% 11.2%;
                --secondary: 217.2 32.6% 17.5%;
                --secondary-foreground: 210 40% 98%;
                --muted: 217.2 32.6% 17.5%;
                --muted-foreground: 215 20.2% 65.1%;
                --accent: 217.2 32.6% 17.5%;
                --accent-foreground: 210 40% 98%;
                --destructive: 0 62.8% 30.6%;
                --destructive-foreground: 210 40% 98%;
                --border: 217.2 32.6% 17.5%;
                --input: 217.2 32.6% 17.5%;
                --ring: 224.3 76.3% 48%;
            }
        }
        @layer base {
            * {
                @apply border-border;
            }
            body {
                @apply bg-background text-foreground;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800">
    <!-- 顶部导航 -->
    <nav class="sticky top-0 z-50 w-full border-b bg-white/80 dark:bg-slate-900/80 backdrop-blur-md supports-[backdrop-filter]:bg-white/60">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-satellite-dish text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 dark:from-slate-100 dark:to-slate-300 bg-clip-text text-transparent">
                        NGA Monitor
                    </h1>
                    <p class="text-xs text-muted-foreground">智能监控与 AI 分析系统</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <a href="/" class="nav-btn active px-4 py-2 rounded-lg text-sm font-medium transition-all bg-primary text-primary-foreground shadow-md">
                    <i class="fas fa-satellite-dish mr-2"></i>监控
                </a>
                <a href="/ai" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-muted-foreground hover:bg-secondary hover:text-secondary-foreground">
                    <i class="fas fa-robot mr-2"></i>AI分析
                </a>
                <a href="/data" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-muted-foreground hover:bg-secondary hover:text-secondary-foreground">
                    <i class="fas fa-database mr-2"></i>数据
                </a>
            </div>
        </div>
    </nav>

    <!-- 左侧悬浮导航 -->
    <div class="fixed left-4 top-1/2 -translate-y-1/2 z-40 flex flex-col gap-2 bg-card/90 backdrop-blur rounded-xl shadow-lg border p-2">
        <a href="/" class="w-10 h-10 rounded-lg bg-primary text-primary-foreground flex items-center justify-center transition-all shadow-md" title="监控">
            <i class="fas fa-satellite-dish"></i>
        </a>
        <a href="/ai" class="w-10 h-10 rounded-lg hover:bg-muted flex items-center justify-center text-muted-foreground transition-all" title="AI分析">
            <i class="fas fa-robot"></i>
        </a>
        <a href="/data" class="w-10 h-10 rounded-lg hover:bg-muted flex items-center justify-center text-muted-foreground transition-all" title="数据">
            <i class="fas fa-database"></i>
        </a>
        <a href="/analytics" class="w-10 h-10 rounded-lg hover:bg-muted flex items-center justify-center text-muted-foreground transition-all" title="情绪分析">
            <i class="fas fa-chart-line"></i>
        </a>
    </div>

    <main class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- 全局提示 -->
        <div id="alert" class="hidden fixed top-20 right-4 z-50 max-w-md animate-in slide-in-from-top-2"></div>

        <!-- 统计卡片 -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <i class="fas fa-chart-line text-primary"></i>
                运行概览
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="stats-grid">
                <!-- 动态生成 -->
            </div>
        </section>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- 左侧主要内容 -->
            <div class="xl:col-span-2 space-y-6">
                <!-- 监控目标列表 -->
                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-card to-muted/30">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-semibold flex items-center gap-2">
                                <i class="fas fa-bullseye text-primary"></i>
                                监控目标
                            </h2>
                            <button onclick="document.getElementById('add-target-section').scrollIntoView({behavior: 'smooth'})" 
                                    class="inline-flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm font-medium hover:bg-primary/90 transition-all shadow-md hover:shadow-lg">
                                <i class="fas fa-plus"></i>
                                添加目标
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-3 px-4 font-semibold text-muted-foreground text-sm">用户</th>
                                        <th class="text-left py-3 px-4 font-semibold text-muted-foreground text-sm">状态</th>
                                        <th class="text-left py-3 px-4 font-semibold text-muted-foreground text-sm">间隔</th>
                                        <th class="text-left py-3 px-4 font-semibold text-muted-foreground text-sm">更新</th>
                                        <th class="text-right py-3 px-4 font-semibold text-muted-foreground text-sm">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="targets-table" class="text-sm">
                                    <!-- 动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- 调度规则 -->
                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-card to-muted/30">
                        <h2 class="text-xl font-semibold flex items-center gap-2">
                            <i class="fas fa-clock text-primary"></i>
                            调度规则
                        </h2>
                    </div>
                    <div class="p-6">
                        <div id="schedule-status" class="mb-6 p-4 rounded-xl bg-muted/50 border">
                            <p class="text-muted-foreground">加载中...</p>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full mb-6">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-3 px-4 font-semibold text-muted-foreground text-sm">规则</th>
                                        <th class="text-left py-3 px-4 font-semibold text-muted-foreground text-sm">时段</th>
                                        <th class="text-left py-3 px-4 font-semibold text-muted-foreground text-sm">模式</th>
                                        <th class="text-right py-3 px-4 font-semibold text-muted-foreground text-sm">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="schedule-rules-body">
                                    <!-- 动态生成 -->
                                </tbody>
                            </table>
                        </div>

                        <div class="border-t pt-6">
                            <h3 class="font-semibold mb-4 text-sm text-muted-foreground uppercase tracking-wider">添加规则</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                                <div class="space-y-2">
                                    <label class="text-sm font-medium">规则名称</label>
                                    <input type="text" id="rule-name" placeholder="如：夜间模式" 
                                           class="w-full px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium">开始时间</label>
                                    <input type="text" id="rule-start" placeholder="00:00" maxlength="5"
                                           class="w-full px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium">结束时间</label>
                                    <input type="text" id="rule-end" placeholder="08:00" maxlength="5"
                                           class="w-full px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium">间隔(秒)</label>
                                    <input type="number" id="rule-interval" value="60" min="0"
                                           class="w-full px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium">总结模式</label>
                                    <select id="rule-summary" 
                                            class="w-full px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                                        <option value="false">否</option>
                                        <option value="true">是</option>
                                    </select>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium">优先级</label>
                                    <input type="number" id="rule-priority" value="0"
                                           class="w-full px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                                </div>
                            </div>
                            <button onclick="addScheduleRule()" 
                                    class="mt-4 inline-flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm font-medium hover:bg-primary/90 transition-all shadow-md">
                                <i class="fas fa-plus"></i>
                                添加规则
                            </button>
                        </div>
                    </div>
                </section>

                <!-- 日志 -->
                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-card to-muted/30">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <h2 class="text-xl font-semibold flex items-center gap-2">
                                <i class="fas fa-terminal text-primary"></i>
                                系统日志
                            </h2>
                            <div class="flex items-center gap-2">
                                <select id="log-level" onchange="loadLogs()"
                                        class="px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20">
                                    <option value="">全部级别</option>
                                    <option value="INFO">INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                </select>
                                <button onclick="loadLogs()" 
                                        class="p-2 rounded-lg border hover:bg-muted transition-all" title="刷新">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button onclick="cleanupLogs()" 
                                        class="px-3 py-2 rounded-lg border text-destructive hover:bg-destructive/10 transition-all text-sm">
                                    <i class="fas fa-trash-alt mr-1"></i>清理
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="overflow-x-auto max-h-96 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="sticky top-0 bg-card">
                                    <tr class="border-b">
                                        <th class="text-left py-2 px-3 font-medium text-muted-foreground">时间</th>
                                        <th class="text-left py-2 px-3 font-medium text-muted-foreground">级别</th>
                                        <th class="text-left py-2 px-3 font-medium text-muted-foreground">消息</th>
                                    </tr>
                                </thead>
                                <tbody id="logs-table">
                                    <!-- 动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>

            <!-- 右侧侧边栏 -->
            <div class="space-y-6">
                <!-- Cookie 状态 -->
                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-shield-alt text-primary"></i>
                            登录状态
                        </h2>
                    </div>
                    <div class="p-6" id="cookie-status">
                        <div class="animate-pulse flex space-x-4">
                            <div class="flex-1 space-y-4 py-1">
                                <div class="h-4 bg-muted rounded w-3/4"></div>
                                <div class="space-y-2">
                                    <div class="h-4 bg-muted rounded"></div>
                                    <div class="h-4 bg-muted rounded w-5/6"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Webhook 配置 -->
                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fab fa-discord text-[#5865F2]"></i>
                            Discord Webhook
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="p-3 rounded-lg bg-muted/50 border text-sm break-all">
                            <span class="text-muted-foreground">当前:</span>
                            <span id="current-webhook" class="ml-2">{{ webhook }}</span>
                        </div>
                        <div class="space-y-2">
                            <input type="url" id="webhook-url" placeholder="https://discord.com/api/webhooks/..." 
                                   class="w-full px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                            <div class="flex gap-2">
                                <button onclick="updateWebhook()" 
                                        class="flex-1 px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm font-medium hover:bg-primary/90 transition-all">
                                    更新
                                </button>
                                <button onclick="testWebhook()" 
                                        class="px-4 py-2 border rounded-lg text-sm font-medium hover:bg-muted transition-all">
                                    测试
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 添加目标 -->
                <section id="add-target-section" class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-user-plus text-primary"></i>
                            添加监控
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="space-y-2">
                            <label class="text-sm font-medium">NGA 用户链接</label>
                            <div class="flex gap-2">
                                <input type="url" id="parse-url" placeholder="https://nga.178.com/nuke.php?func=ucp&uid=..." 
                                       class="flex-1 px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                                <button onclick="parseUrl()" 
                                        class="px-3 py-2 bg-secondary text-secondary-foreground rounded-lg text-sm hover:bg-secondary/80 transition-all">
                                    解析
                                </button>
                            </div>
                        </div>
                        
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center">
                                <span class="w-full border-t"></span>
                            </div>
                            <div class="relative flex justify-center text-xs uppercase">
                                <span class="bg-card px-2 text-muted-foreground">或手动输入</span>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm font-medium">UID</label>
                                <input type="text" id="new-uid" placeholder="例如: 557398" 
                                       class="w-full px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all mt-1">
                            </div>
                            <div>
                                <label class="text-sm font-medium">名称（可选）</label>
                                <input type="text" id="new-name" placeholder="显示名称" 
                                       class="w-full px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all mt-1">
                            </div>
                            <div>
                                <label class="text-sm font-medium">检查间隔（秒）</label>
                                <input type="number" id="new-interval" value="60" min="10" 
                                       class="w-full px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all mt-1">
                            </div>
                            <div>
                                <label class="text-sm font-medium flex items-center gap-1">
                                    <i class="fas fa-filter text-muted-foreground"></i>
                                    关键词过滤
                                </label>
                                <input type="text" id="new-keywords" placeholder="股票,基金,比特币（逗号分隔，留空不过滤）" 
                                       class="w-full px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all mt-1">
                                <select id="new-keyword-mode" class="w-full mt-2 px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                                    <option value="ANY">匹配任一关键词</option>
                                    <option value="ALL">匹配全部关键词</option>
                                    <option value="REGEX">正则表达式</option>
                                </select>
                            </div>
                            <button onclick="addTarget()" 
                                    class="w-full px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm font-medium hover:bg-primary/90 transition-all shadow-md">
                                <i class="fas fa-plus mr-2"></i>添加监控
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script>
        // 显示提示
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500'
            };
            alert.innerHTML = `
                <div class="${colors[type] || colors.success} text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-2">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            alert.classList.remove('hidden');
            setTimeout(() => {
                alert.classList.add('hidden');
            }, 5000);
        }

        // 格式化时间
        function formatTime(utcTime) {
            if (!utcTime) return '-';
            const date = new Date(utcTime);
            const offset = 8 * 60 * 60 * 1000;
            const localDate = new Date(date.getTime() + offset);
            return localDate.toLocaleString('zh-CN', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        }

        // 加载统计
        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                const grid = document.getElementById('stats-grid');
                grid.innerHTML = `
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm">监控目标</p>
                                <p class="text-3xl font-bold mt-1">${data.targets.total}</p>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
                                <i class="fas fa-bullseye text-xl"></i>
                            </div>
                        </div>
                        <p class="text-blue-100 text-sm mt-2">${data.targets.enabled} 个已启用</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm">总发送数</p>
                                <p class="text-3xl font-bold mt-1">${data.sent.total}</p>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
                                <i class="fas fa-paper-plane text-xl"></i>
                            </div>
                        </div>
                        <p class="text-green-100 text-sm mt-2">成功率 ${data.sent.success_rate || 0}%</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm">24小时发送</p>
                                <p class="text-3xl font-bold mt-1">${data.sent.recent_24h}</p>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
                                <i class="fas fa-clock text-xl"></i>
                            </div>
                        </div>
                        <p class="text-purple-100 text-sm mt-2">最近活跃</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm">发送失败</p>
                                <p class="text-3xl font-bold mt-1">${data.sent.failed || 0}</p>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-xl"></i>
                            </div>
                        </div>
                        <p class="text-orange-100 text-sm mt-2">需关注</p>
                    </div>
                `;
            } catch (e) {
                console.error('加载统计失败:', e);
            }
        }

        // 加载目标列表
        async function loadTargets() {
            try {
                const res = await fetch('/api/targets');
                const data = await res.json();
                const tbody = document.getElementById('targets-table');
                tbody.innerHTML = data.targets.map(t => {
                    const hasKeywords = t.keywords && t.keywords.trim();
                    const keywordsBadge = hasKeywords 
                        ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400 ml-2" title="${t.keywords}">
                             <i class="fas fa-filter text-[10px]"></i>
                             ${t.keyword_mode === 'REGEX' ? '正则' : t.keyword_mode === 'ALL' ? '全部' : '任一'}
                           </span>`
                        : '';
                    
                    return `
                    <tr class="border-b hover:bg-muted/50 transition-colors">
                        <td class="py-4 px-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-xs font-bold">
                                    ${(t.name || t.uid).charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div class="flex items-center">
                                        <p class="font-medium">${t.name || '-'}</p>
                                        ${keywordsBadge}
                                    </div>
                                    <p class="text-xs text-muted-foreground">UID: ${t.uid}</p>
                                    ${hasKeywords ? `<p class="text-xs text-muted-foreground mt-0.5 truncate max-w-[200px]" title="${t.keywords}">${t.keywords}</p>` : ''}
                                </div>
                            </div>
                        </td>
                        <td class="py-4 px-4">
                            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium ${t.enabled ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400'}">
                                <span class="w-1.5 h-1.5 rounded-full ${t.enabled ? 'bg-green-500' : 'bg-gray-400'}"></span>
                                ${t.enabled ? '运行中' : '已停止'}
                            </span>
                        </td>
                        <td class="py-4 px-4 text-muted-foreground">${t.check_interval}s</td>
                        <td class="py-4 px-4 text-muted-foreground text-sm">${formatTime(t.updated_at)}</td>
                        <td class="py-4 px-4">
                            <div class="flex items-center justify-end gap-1">
                                <button onclick="testTarget(${t.id})" class="p-2 rounded-lg hover:bg-primary/10 text-primary transition-all" title="测试">
                                    <i class="fas fa-play text-xs"></i>
                                </button>
                                <button onclick="forceSendTarget(${t.id})" class="p-2 rounded-lg hover:bg-orange-500/10 text-orange-500 transition-all" title="强制发送">
                                    <i class="fas fa-paper-plane text-xs"></i>
                                </button>
                                <button onclick="deleteTarget(${t.id})" class="p-2 rounded-lg hover:bg-red-500/10 text-red-500 transition-all" title="删除">
                                    <i class="fas fa-trash-alt text-xs"></i>
                                </button>
                                <button onclick="toggleTarget(${t.id}, ${!t.enabled})" class="p-2 rounded-lg hover:bg-muted transition-all" title="${t.enabled ? '关闭' : '启动'}">
                                    <i class="fas ${t.enabled ? 'fa-toggle-on text-blue-500' : 'fa-toggle-off text-gray-400'} text-lg"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `}).join('') || '<tr><td colspan="5" class="py-8 text-center text-muted-foreground">暂无监控目标</td></tr>';
            } catch (e) {
                console.error('加载目标失败:', e);
            }
        }

        // 加载 Cookie 状态
        async function loadCookieStatus() {
            try {
                const res = await fetch('/api/cookie-status');
                const data = await res.json();
                const container = document.getElementById('cookie-status');
                
                if (!data.exists) {
                    container.innerHTML = `
                        <div class="p-4 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-exclamation-circle"></i>
                                <span class="font-medium">Cookie 文件不存在</span>
                            </div>
                            <p class="text-sm mt-1 opacity-80">请先运行 export_nga_state.py</p>
                        </div>
                    `;
                    return;
                }

                let cookiesHtml = '';
                for (const [name, info] of Object.entries(data.nga_cookies || {})) {
                    const isValid = info.has_value;
                    cookiesHtml += `
                        <div class="flex items-center justify-between py-2 px-3 rounded-lg ${isValid ? 'bg-green-50 dark:bg-green-900/20' : 'bg-red-50 dark:bg-red-900/20'} mb-2">
                            <div class="flex items-center gap-2">
                                <i class="fas ${isValid ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'}"></i>
                                <span class="text-sm font-medium">${name}</span>
                            </div>
                            <span class="text-xs ${isValid ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                                ${isValid ? '有效' : '无效'}
                            </span>
                        </div>
                    `;
                }

                container.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-muted-foreground">总 Cookie:</span>
                            <span class="font-medium">${data.cookie_count}</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-muted-foreground">最后更新:</span>
                            <span class="font-medium">${new Date(data.last_modified).toLocaleString('zh-CN')}</span>
                        </div>
                        <div class="border-t pt-3 mt-3">
                            <p class="text-sm font-medium mb-2">关键 Cookie</p>
                            ${cookiesHtml || '<p class="text-sm text-muted-foreground">无关键 Cookie</p>'}
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('加载 Cookie 状态失败:', e);
            }
        }

        // 加载调度规则
        async function loadScheduleRules() {
            try {
                const res = await fetch('/api/schedule/rules');
                const data = await res.json();
                const tbody = document.getElementById('schedule-rules-body');
                tbody.innerHTML = data.rules.map(r => `
                    <tr class="border-b hover:bg-muted/50 transition-colors">
                        <td class="py-3 px-4">
                            <span class="font-medium">${r.name}</span>
                        </td>
                        <td class="py-3 px-4 text-muted-foreground">
                            ${r.start_time} - ${r.end_time}
                        </td>
                        <td class="py-3 px-4">
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${r.is_summary ? 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400' : r.interval_seconds > 0 ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400' : 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400'}">
                                ${r.is_summary ? '总结模式' : r.interval_seconds > 0 ? `每${r.interval_seconds}秒` : '暂停'}
                            </span>
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex items-center justify-end gap-1">
                                <button onclick="toggleScheduleRule(${r.id}, ${!r.enabled})" class="p-2 rounded-lg hover:bg-muted transition-all" title="${r.enabled ? '禁用' : '启用'}">
                                    <i class="fas ${r.enabled ? 'fa-toggle-on text-blue-500' : 'fa-toggle-off text-gray-400'} text-lg"></i>
                                </button>
                                <button onclick="deleteScheduleRule(${r.id})" class="p-2 rounded-lg hover:bg-red-500/10 text-red-500 transition-all" title="删除">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="4" class="py-8 text-center text-muted-foreground">暂无规则</td></tr>';
            } catch (e) {
                console.error('加载调度规则失败:', e);
            }
        }

        // 加载调度状态
        async function loadScheduleStatus() {
            try {
                const res = await fetch('/api/schedule/status');
                const data = await res.json();
                const container = document.getElementById('schedule-status');
                
                container.innerHTML = `
                    <div class="flex items-center gap-4 flex-wrap">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full ${data.current_rule ? 'bg-green-500 animate-pulse' : 'bg-gray-400'}"></div>
                            <span class="font-medium">${data.current_rule ? data.current_rule.name : '等待中'}</span>
                        </div>
                        <span class="text-muted-foreground text-sm">|</span>
                        <span class="text-muted-foreground text-sm">${data.status}</span>
                        ${data.next_check ? `
                            <span class="text-muted-foreground text-sm">|</span>
                            <span class="text-muted-foreground text-sm">下次: ${new Date(data.next_check).toLocaleTimeString('zh-CN')}</span>
                        ` : ''}
                    </div>
                `;
            } catch (e) {
                console.error('加载调度状态失败:', e);
            }
        }

        // 加载日志
        async function loadLogs() {
            try {
                const level = document.getElementById('log-level').value;
                const url = level ? `/api/logs?level=${level}` : '/api/logs';
                const res = await fetch(url);
                const data = await res.json();
                const tbody = document.getElementById('logs-table');
                
                const levelColors = {
                    'ERROR': 'text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20',
                    'WARNING': 'text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/20',
                    'DEBUG': 'text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20'
                };
                
                tbody.innerHTML = data.logs.slice(0, 50).map(l => `
                    <tr class="border-b hover:bg-muted/30 transition-colors ${levelColors[l.level] || ''}">
                        <td class="py-2 px-3 text-xs text-muted-foreground whitespace-nowrap">${formatTime(l.created_at)}</td>
                        <td class="py-2 px-3">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${levelColors[l.level] || 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'}">
                                ${l.level}
                            </span>
                        </td>
                        <td class="py-2 px-3 text-sm">${l.message}</td>
                    </tr>
                `).join('') || '<tr><td colspan="3" class="py-8 text-center text-muted-foreground">暂无日志</td></tr>';
            } catch (e) {
                console.error('加载日志失败:', e);
            }
        }

        // 解析 URL
        async function parseUrl() {
            const url = document.getElementById('parse-url').value.trim();
            if (!url) {
                showAlert('请输入 URL', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/parse-url', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({url})
                });
                
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('new-uid').value = data.uid;
                    // 自动填充用户名（如果获取到）
                    if (data.username) {
                        document.getElementById('new-name').value = data.username;
                        showAlert(`解析成功: ${data.username} (UID: ${data.uid})`);
                    } else {
                        showAlert(`解析成功: UID ${data.uid}`);
                    }
                } else {
                    const err = await res.json();
                    showAlert(err.detail || '解析失败', 'error');
                }
            } catch (e) {
                showAlert('请求失败', 'error');
            }
        }

        // 添加目标
        async function addTarget() {
            const uid = document.getElementById('new-uid').value.trim();
            const name = document.getElementById('new-name').value.trim();
            const interval = parseInt(document.getElementById('new-interval').value) || 60;
            const keywords = document.getElementById('new-keywords').value.trim();
            const keywordMode = document.getElementById('new-keyword-mode').value;
            
            if (!uid) {
                showAlert('请输入 UID', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/targets', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        uid, 
                        name, 
                        check_interval: interval,
                        keywords,
                        keyword_mode: keywordMode
                    })
                });
                
                if (res.ok) {
                    showAlert('添加成功');
                    document.getElementById('new-uid').value = '';
                    document.getElementById('new-name').value = '';
                    document.getElementById('new-keywords').value = '';
                    loadTargets();
                    loadStats();
                } else {
                    const err = await res.json();
                    showAlert(err.detail || '添加失败', 'error');
                }
            } catch (e) {
                showAlert('请求失败', 'error');
            }
        }

        // 其他操作函数...
        async function toggleTarget(id, enabled) {
            try {
                const res = await fetch(`/api/targets/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({enabled})
                });
                
                if (res.ok) {
                    showAlert(enabled ? '已启用' : '已禁用');
                    loadTargets();
                    loadStats();
                }
            } catch (e) {
                showAlert('操作失败', 'error');
            }
        }

        async function deleteTarget(id) {
            if (!confirm('确定要删除吗？')) return;
            
            try {
                const res = await fetch(`/api/targets/${id}`, {method: 'DELETE'});
                if (res.ok) {
                    showAlert('删除成功');
                    loadTargets();
                    loadStats();
                }
            } catch (e) {
                showAlert('删除失败', 'error');
            }
        }

        async function testTarget(id) {
            try {
                showAlert('正在测试...', 'warning');
                const res = await fetch(`/api/targets/${id}/test`, {method: 'POST'});
                if (res.ok) {
                    const data = await res.json();
                    showAlert(data.message);
                    loadStats();
                } else {
                    const err = await res.json();
                    showAlert(err.detail || '测试失败', 'error');
                }
            } catch (e) {
                showAlert('请求失败', 'error');
            }
        }

        async function forceSendTarget(id) {
            if (!confirm('确定强制发送？')) return;
            try {
                showAlert('正在发送...', 'warning');
                const res = await fetch(`/api/targets/${id}/force-send`, {method: 'POST'});
                if (res.ok) {
                    showAlert('发送成功');
                    loadStats();
                } else {
                    const err = await res.json();
                    showAlert(err.detail || '发送失败', 'error');
                }
            } catch (e) {
                showAlert('请求失败', 'error');
            }
        }

        async function updateWebhook() {
            const url = document.getElementById('webhook-url').value.trim();
            if (!url) {
                showAlert('请输入 URL', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/webhook', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({url})
                });
                
                if (res.ok) {
                    showAlert('Webhook 已更新');
                    document.getElementById('current-webhook').textContent = url.substring(0, 30) + '...';
                    document.getElementById('webhook-url').value = '';
                }
            } catch (e) {
                showAlert('更新失败', 'error');
            }
        }

        async function testWebhook() {
            try {
                showAlert('正在测试...', 'warning');
                const res = await fetch('/api/webhook/test', {method: 'POST'});
                if (res.ok) {
                    showAlert('测试消息已发送');
                } else {
                    showAlert('测试失败', 'error');
                }
            } catch (e) {
                showAlert('请求失败', 'error');
            }
        }

        async function cleanupLogs() {
            if (!confirm('确定清理 7 天前的日志？')) return;
            
            try {
                const res = await fetch('/api/logs/cleanup', {method: 'POST'});
                if (res.ok) {
                    const data = await res.json();
                    showAlert(`已清理 ${data.deleted} 条日志`);
                    loadLogs();
                }
            } catch (e) {
                showAlert('清理失败', 'error');
            }
        }

        async function addScheduleRule() {
            const name = document.getElementById('rule-name').value.trim();
            const startTime = document.getElementById('rule-start').value.trim();
            const endTime = document.getElementById('rule-end').value.trim();
            const interval = parseInt(document.getElementById('rule-interval').value) || 60;
            const isSummary = document.getElementById('rule-summary').value === 'true';
            const priority = parseInt(document.getElementById('rule-priority').value) || 0;
            
            if (!name || !startTime || !endTime) {
                showAlert('请填写完整信息', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/schedule/rules', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name, start_time: startTime, end_time: endTime,
                        interval_seconds: interval, is_summary: isSummary,
                        priority, enabled: true
                    })
                });
                
                if (res.ok) {
                    showAlert('规则添加成功');
                    document.getElementById('rule-name').value = '';
                    document.getElementById('rule-start').value = '';
                    document.getElementById('rule-end').value = '';
                    loadScheduleRules();
                    loadScheduleStatus();
                } else {
                    const err = await res.json();
                    showAlert(err.detail || '添加失败', 'error');
                }
            } catch (e) {
                showAlert('请求失败', 'error');
            }
        }

        async function toggleScheduleRule(id, enabled) {
            try {
                const res = await fetch(`/api/schedule/rules/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({enabled})
                });
                
                if (res.ok) {
                    showAlert(enabled ? '规则已启用' : '规则已禁用');
                    loadScheduleRules();
                    loadScheduleStatus();
                }
            } catch (e) {
                showAlert('操作失败', 'error');
            }
        }

        async function deleteScheduleRule(id) {
            if (!confirm('确定要删除吗？')) return;
            
            try {
                const res = await fetch(`/api/schedule/rules/${id}`, {method: 'DELETE'});
                if (res.ok) {
                    showAlert('规则已删除');
                    loadScheduleRules();
                    loadScheduleStatus();
                }
            } catch (e) {
                showAlert('删除失败', 'error');
            }
        }

        // 页面加载
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadTargets();
            loadCookieStatus();
            loadScheduleRules();
            loadScheduleStatus();
            loadLogs();
        });

        // 自动刷新
        setInterval(() => {
            loadStats();
            loadLogs();
        }, 30000);
    </script>
</body>
</html>
