<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>情绪分析 - NGA Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer base {
            :root {
                --background: 0 0% 100%;
                --foreground: 222.2 84% 4.9%;
                --card: 0 0% 100%;
                --card-foreground: 222.2 84% 4.9%;
                --popover: 0 0% 100%;
                --popover-foreground: 222.2 84% 4.9%;
                --primary: 221.2 83.2% 53.3%;
                --primary-foreground: 210 40% 98%;
                --secondary: 210 40% 96.1%;
                --secondary-foreground: 222.2 47.4% 11.2%;
                --muted: 210 40% 96.1%;
                --muted-foreground: 215.4 16.3% 46.9%;
                --accent: 210 40% 96.1%;
                --accent-foreground: 222.2 47.4% 11.2%;
                --destructive: 0 84.2% 60.2%;
                --destructive-foreground: 210 40% 98%;
                --border: 214.3 31.8% 91.4%;
                --input: 214.3 31.8% 91.4%;
                --ring: 221.2 83.2% 53.3%;
                --radius: 0.5rem;
            }
            .dark {
                --background: 222.2 84% 4.9%;
                --foreground: 210 40% 98%;
                --card: 222.2 84% 4.9%;
                --card-foreground: 210 40% 98%;
                --popover: 222.2 84% 4.9%;
                --popover-foreground: 210 40% 98%;
                --primary: 217.2 91.2% 59.8%;
                --primary-foreground: 222.2 47.4% 11.2%;
                --secondary: 217.2 32.6% 17.5%;
                --secondary-foreground: 210 40% 98%;
                --muted: 217.2 32.6% 17.5%;
                --muted-foreground: 215 20.2% 65.1%;
                --accent: 217.2 32.6% 17.5%;
                --accent-foreground: 210 40% 98%;
                --destructive: 0 62.8% 30.6%;
                --destructive-foreground: 210 40% 98%;
                --border: 217.2 32.6% 17.5%;
                --input: 217.2 32.6% 17.5%;
                --ring: 224.3 76.3% 48%;
            }
        }
    </style>
</head>
<body class="bg-background text-foreground min-h-screen">
    <!-- 导航栏 -->
    <nav class="sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
        <div class="container flex h-14 items-center justify-between px-4">
            <div class="flex items-center gap-4">
                <h1 class="text-lg font-semibold">
                    <i class="fas fa-chart-line text-primary mr-2"></i>情绪分析
                </h1>
                <nav class="hidden md:flex items-center gap-1 text-sm">
                    <a href="/" class="px-3 py-2 rounded-md hover:bg-muted transition-colors">监控</a>
                    <a href="/ai" class="px-3 py-2 rounded-md hover:bg-muted transition-colors">AI分析</a>
                    <a href="/data" class="px-3 py-2 rounded-md hover:bg-muted transition-colors">数据</a>
                    <span class="px-3 py-2 rounded-md bg-muted font-medium">情绪趋势</span>
                </nav>
            </div>
            <div class="flex items-center gap-2">
                <span id="last-update" class="text-xs text-muted-foreground"></span>
                <button onclick="refreshData()" class="p-2 rounded-lg hover:bg-muted transition-all" title="刷新">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-6">
        <!-- 时间范围选择 -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-2">
                <span class="text-sm text-muted-foreground">时间范围：</span>
                <div class="flex items-center gap-1 bg-muted rounded-lg p-1">
                    <button onclick="setRange(7)" class="range-btn px-3 py-1.5 text-sm rounded-md transition-all" data-days="7">7天</button>
                    <button onclick="setRange(30)" class="range-btn px-3 py-1.5 text-sm rounded-md bg-background shadow-sm transition-all" data-days="30">30天</button>
                    <button onclick="setRange(60)" class="range-btn px-3 py-1.5 text-sm rounded-md transition-all" data-days="60">60天</button>
                    <button onclick="setRange(90)" class="range-btn px-3 py-1.5 text-sm rounded-md transition-all" data-days="90">90天</button>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-sm text-muted-foreground">用户筛选：</span>
                <select id="target-filter" onchange="filterByTarget()" class="px-3 py-1.5 text-sm rounded-lg border bg-background">
                    <option value="">所有用户</option>
                </select>
            </div>
        </div>

        <!-- 汇总卡片 -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-4 text-white shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-xs">总回复数</p>
                        <p class="text-2xl font-bold mt-1" id="summary-total">-</p>
                    </div>
                    <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                        <i class="fas fa-comments text-lg"></i>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-4 text-white shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-xs">已分析</p>
                        <p class="text-2xl font-bold mt-1" id="summary-analyzed">-</p>
                    </div>
                    <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                        <i class="fas fa-brain text-lg"></i>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-4 text-white shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 text-xs">平均情绪</p>
                        <p class="text-2xl font-bold mt-1" id="summary-sentiment">-</p>
                    </div>
                    <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                        <i class="fas fa-smile text-lg"></i>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-4 text-white shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-orange-100 text-xs">最活跃日</p>
                        <p class="text-sm font-bold mt-1" id="summary-active">-</p>
                    </div>
                    <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                        <i class="fas fa-calendar-day text-lg"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 情绪趋势图 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div class="lg:col-span-2 bg-card rounded-2xl p-6 shadow-sm border">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold">
                        <i class="fas fa-chart-line text-primary mr-2"></i>情绪趋势
                    </h3>
                    <div class="flex items-center gap-2 text-xs">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span>乐观</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-gray-400"></span>中性</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span>悲观</span>
                    </div>
                </div>
                <div id="sentiment-chart" style="height: 350px;"></div>
            </div>
            
            <div class="bg-card rounded-2xl p-6 shadow-sm border">
                <h3 class="font-semibold mb-4">
                    <i class="fas fa-pie-chart text-primary mr-2"></i>情绪分布
                </h3>
                <div id="distribution-chart" style="height: 350px;"></div>
            </div>
        </div>

        <!-- 活跃度热力图和关键词 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-card rounded-2xl p-6 shadow-sm border">
                <h3 class="font-semibold mb-4">
                    <i class="fas fa-fire text-primary mr-2"></i>活跃度热力图
                </h3>
                <div id="heatmap-chart" style="height: 300px;"></div>
            </div>
            
            <div class="bg-card rounded-2xl p-6 shadow-sm border">
                <h3 class="font-semibold mb-4">
                    <i class="fas fa-tags text-primary mr-2"></i>关键词情绪排行
                </h3>
                <div id="keywords-chart" style="height: 300px;"></div>
            </div>
        </div>

        <!-- 说明 -->
        <div class="bg-muted/50 rounded-xl p-4 text-sm text-muted-foreground">
            <p><i class="fas fa-info-circle mr-1"></i> 情绪分析说明：</p>
            <ul class="mt-2 space-y-1 ml-5 list-disc">
                <li>情绪指数范围：-1.0（极度悲观）到 +1.0（极度乐观）</li>
                <li>数据每日凌晨自动更新，分析最近回复的情绪倾向</li>
                <li>关键词提取基于常见投资词汇，情绪为该词出现时回复的平均情绪</li>
            </ul>
        </div>
    </main>

    <script>
        let currentDays = 30;
        let currentTarget = '';
        let sentimentChart, distributionChart, heatmapChart, keywordsChart;

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            loadTargets();
            refreshData();
        });

        function initCharts() {
            sentimentChart = echarts.init(document.getElementById('sentiment-chart'));
            distributionChart = echarts.init(document.getElementById('distribution-chart'));
            heatmapChart = echarts.init(document.getElementById('heatmap-chart'));
            keywordsChart = echarts.init(document.getElementById('keywords-chart'));

            window.addEventListener('resize', () => {
                sentimentChart.resize();
                distributionChart.resize();
                heatmapChart.resize();
                keywordsChart.resize();
            });
        }

        async function loadTargets() {
            try {
                const res = await fetch('/api/targets');
                const data = await res.json();
                const select = document.getElementById('target-filter');
                
                data.targets.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id;
                    option.textContent = t.name || `用户${t.uid}`;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('加载用户失败:', e);
            }
        }

        function setRange(days) {
            currentDays = days;
            document.querySelectorAll('.range-btn').forEach(btn => {
                if (parseInt(btn.dataset.days) === days) {
                    btn.classList.add('bg-background', 'shadow-sm');
                } else {
                    btn.classList.remove('bg-background', 'shadow-sm');
                }
            });
            refreshData();
        }

        function filterByTarget() {
            currentTarget = document.getElementById('target-filter').value;
            refreshData();
        }

        async function refreshData() {
            try {
                // 加载汇总数据
                const summaryRes = await fetch(`/api/analytics/summary?days=${currentDays}`);
                const summary = await summaryRes.json();
                updateSummary(summary);

                // 加载情绪趋势
                const trendRes = await fetch(`/api/analytics/sentiment/trend?days=${currentDays}${currentTarget ? '&target_id='+currentTarget : ''}`);
                const trend = await trendRes.json();
                updateSentimentChart(trend);

                // 加载情绪分布
                const distRes = await fetch(`/api/analytics/sentiment/distribution?days=${currentDays}${currentTarget ? '&target_id='+currentTarget : ''}`);
                const dist = await distRes.json();
                updateDistributionChart(dist);

                // 加载活跃度热力图
                const heatmapRes = await fetch(`/api/analytics/activity/heatmap?days=${currentDays}${currentTarget ? '&target_id='+currentTarget : ''}`);
                const heatmap = await heatmapRes.json();
                updateHeatmapChart(heatmap);

                // 加载关键词
                const keywordsRes = await fetch(`/api/analytics/keywords/sentiment?days=${currentDays}${currentTarget ? '&target_id='+currentTarget : ''}`);
                const keywords = await keywordsRes.json();
                updateKeywordsChart(keywords);

                document.getElementById('last-update').textContent = 
                    '更新于: ' + new Date().toLocaleTimeString('zh-CN');
            } catch (e) {
                console.error('刷新数据失败:', e);
            }
        }

        function updateSummary(data) {
            document.getElementById('summary-total').textContent = data.total_replies || 0;
            document.getElementById('summary-analyzed').textContent = data.analyzed_replies || 0;
            
            const sentiment = data.avg_sentiment || 0;
            const sentimentEl = document.getElementById('summary-sentiment');
            sentimentEl.textContent = sentiment > 0 ? `+${sentiment.toFixed(2)}` : sentiment.toFixed(2);
            sentimentEl.className = 'text-2xl font-bold mt-1 ' + 
                (sentiment > 0.2 ? 'text-green-200' : sentiment < -0.2 ? 'text-red-200' : '');
            
            document.getElementById('summary-active').textContent = data.most_active_day || '-';
        }

        function updateSentimentChart(data) {
            const series = data.series.map((s, index) => ({
                name: s.name,
                type: 'line',
                smooth: true,
                symbol: 'circle',
                symbolSize: 6,
                lineStyle: { width: 3 },
                data: s.data,
                markLine: {
                    data: [{ yAxis: 0, lineStyle: { color: '#999', type: 'dashed' } }]
                }
            }));

            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        let html = params[0].axisValue + '<br/>';
                        params.forEach(p => {
                            const val = p.value !== null ? (p.value > 0 ? '+' + p.value : p.value) : '-';
                            html += `${p.marker} ${p.seriesName}: ${val}<br/>`;
                        });
                        return html;
                    }
                },
                legend: { bottom: 0 },
                grid: { left: '3%', right: '4%', bottom: '15%', top: '10%', containLabel: true },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: data.dates,
                    axisLabel: { rotate: 45 }
                },
                yAxis: {
                    type: 'value',
                    min: -1,
                    max: 1,
                    splitLine: { lineStyle: { type: 'dashed' } }
                },
                series: series
            };

            sentimentChart.setOption(option, true);
        }

        function updateDistributionChart(data) {
            const option = {
                tooltip: { trigger: 'item' },
                legend: { bottom: 0 },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['50%', '45%'],
                    avoidLabelOverlap: false,
                    itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
                    label: { show: false },
                    emphasis: { label: { show: true, fontSize: 14, fontWeight: 'bold' } },
                    data: [
                        { value: data.positive, name: '乐观', itemStyle: { color: '#22c55e' } },
                        { value: data.neutral, name: '中性', itemStyle: { color: '#9ca3af' } },
                        { value: data.negative, name: '悲观', itemStyle: { color: '#ef4444' } }
                    ]
                }]
            };

            distributionChart.setOption(option, true);
        }

        function updateHeatmapChart(data) {
            // 转换数据格式
            const heatmapData = [];
            data.data.forEach((hourData, hour) => {
                hourData.forEach((count, dayIndex) => {
                    if (count > 0) {
                        heatmapData.push([dayIndex, hour, count]);
                    }
                });
            });

            const option = {
                tooltip: {
                    position: 'top',
                    formatter: function(p) {
                        return `${data.dates[p.data[0]]} ${p.data[1]}时<br/>回复数: ${p.data[2]}`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '15%', top: '5%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: data.dates.map(d => d.slice(5)), // 只显示 MM-DD
                    splitArea: { show: true },
                    axisLabel: { rotate: 45, interval: 'auto' }
                },
                yAxis: {
                    type: 'category',
                    data: data.hours.map(h => h + '时'),
                    splitArea: { show: true }
                },
                visualMap: {
                    min: 0,
                    max: Math.max(...data.data.flat()),
                    calculable: true,
                    orient: 'horizontal',
                    left: 'center',
                    bottom: 0,
                    inRange: { color: ['#f0f9ff', '#0ea5e9', '#0369a1'] }
                },
                series: [{
                    type: 'heatmap',
                    data: heatmapData,
                    label: { show: false },
                    emphasis: { itemStyle: { shadowBlur: 10, shadowColor: 'rgba(0, 0, 0, 0.5)' } }
                }]
            };

            heatmapChart.setOption(option, true);
        }

        function updateKeywordsChart(data) {
            const words = data.keywords.slice(0, 10);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(p) {
                        const d = p[0];
                        return `${d.name}<br/>出现次数: ${d.data.count}<br/>平均情绪: ${d.data.sentiment > 0 ? '+' : ''}${d.data.sentiment}`;
                    }
                },
                grid: { left: '3%', right: '10%', bottom: '3%', top: '3%', containLabel: true },
                xAxis: {
                    type: 'value',
                    min: -1,
                    max: 1,
                    splitLine: { lineStyle: { type: 'dashed' } }
                },
                yAxis: {
                    type: 'category',
                    data: words.map(w => w.word).reverse(),
                    axisLabel: { fontSize: 12 }
                },
                series: [{
                    type: 'bar',
                    data: words.map(w => ({
                        value: w.avg_sentiment,
                        count: w.count,
                        sentiment: w.avg_sentiment,
                        itemStyle: {
                            color: w.avg_sentiment > 0.2 ? '#22c55e' : 
                                   w.avg_sentiment < -0.2 ? '#ef4444' : '#9ca3af'
                        }
                    })).reverse(),
                    barWidth: '60%',
                    label: {
                        show: true,
                        position: 'right',
                        formatter: function(p) {
                            return (p.value > 0 ? '+' : '') + p.value;
                        }
                    }
                }]
            };

            keywordsChart.setOption(option, true);
        }
    </script>
</body>
</html>
