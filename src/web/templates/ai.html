<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGA Monitor - AI 分析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer base {
            :root {
                --background: 0 0% 100%;
                --foreground: 222.2 84% 4.9%;
                --card: 0 0% 100%;
                --card-foreground: 222.2 84% 4.9%;
                --popover: 0 0% 100%;
                --popover-foreground: 222.2 84% 4.9%;
                --primary: 221.2 83.2% 53.3%;
                --primary-foreground: 210 40% 98%;
                --secondary: 210 40% 96.1%;
                --secondary-foreground: 222.2 47.4% 11.2%;
                --muted: 210 40% 96.1%;
                --muted-foreground: 215.4 16.3% 46.9%;
                --accent: 210 40% 96.1%;
                --accent-foreground: 222.2 47.4% 11.2%;
                --destructive: 0 84.2% 60.2%;
                --destructive-foreground: 210 40% 98%;
                --border: 214.3 31.8% 91.4%;
                --input: 214.3 31.8% 91.4%;
                --ring: 221.2 83.2% 53.3%;
                --radius: 0.75rem;
            }
            .dark {
                --background: 222.2 84% 4.9%;
                --foreground: 210 40% 98%;
                --card: 222.2 84% 4.9%;
                --card-foreground: 210 40% 98%;
                --popover: 222.2 84% 4.9%;
                --popover-foreground: 210 40% 98%;
                --primary: 217.2 91.2% 59.8%;
                --primary-foreground: 222.2 47.4% 11.2%;
                --secondary: 217.2 32.6% 17.5%;
                --secondary-foreground: 210 40% 98%;
                --muted: 217.2 32.6% 17.5%;
                --muted-foreground: 215 20.2% 65.1%;
                --accent: 217.2 32.6% 17.5%;
                --accent-foreground: 210 40% 98%;
                --destructive: 0 62.8% 30.6%;
                --destructive-foreground: 210 40% 98%;
                --border: 217.2 32.6% 17.5%;
                --input: 217.2 32.6% 17.5%;
                --ring: 224.3 76.3% 48%;
            }
        }
        @layer base {
            * { @apply border-border; }
            body { @apply bg-background text-foreground; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800">
    <!-- 顶部导航 -->
    <nav class="sticky top-0 z-50 w-full border-b bg-white/80 dark:bg-slate-900/80 backdrop-blur-md">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-robot text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 dark:from-slate-100 dark:to-slate-300 bg-clip-text text-transparent">AI 分析</h1>
                    <p class="text-xs text-muted-foreground">智能投资风格分析</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <a href="/" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-muted-foreground hover:bg-secondary">
                    <i class="fas fa-satellite-dish mr-2"></i>监控
                </a>
                <a href="/ai" class="nav-btn active px-4 py-2 rounded-lg text-sm font-medium transition-all bg-primary text-primary-foreground shadow-md">
                    <i class="fas fa-robot mr-2"></i>AI分析
                </a>
                <a href="/data" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-muted-foreground hover:bg-secondary">
                    <i class="fas fa-database mr-2"></i>数据
                </a>
                </a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- 提示框 -->
        <div id="alert" class="hidden fixed top-20 right-4 z-50 max-w-md"></div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- 左侧：AI 配置 -->
            <div class="space-y-6">
                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-purple-500/10 to-pink-500/10">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-semibold flex items-center gap-2">
                                <i class="fas fa-cog text-purple-500"></i>
                                AI 配置
                            </h2>
                            <span id="config-status" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">未保存</span>
                        </div>
                    </div>
                    <div class="p-6 space-y-4" id="ai-config">
                        <!-- 动态加载配置表单 -->
                    </div>
                </section>

                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-file-alt text-blue-500"></i>
                            提示词模板
                        </h2>
                    </div>
                    <div class="p-6">
                        <div id="templates-list" class="space-y-2">
                            <!-- 动态加载 -->
                        </div>
                    </div>
                </section>
            </div>

            <!-- 中间：分析操作 -->
            <div class="space-y-6">
                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-green-500/10 to-emerald-500/10">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-user-check text-green-500"></i>
                            单用户分析
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="text-sm font-medium">选择用户</label>
                            <select id="single-target" class="w-full mt-1 px-3 py-2 rounded-lg border bg-background">
                                <!-- 动态加载 -->
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">时间范围</label>
                                <select id="single-time-range" class="w-full mt-1 px-3 py-2 rounded-lg border bg-background">
                                    <option value="week">最近一周</option>
                                    <option value="month">最近一月</option>
                                    <option value="all">全部历史</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">情绪周期</label>
                                <button onclick="analyzeSentimentCycle()" class="w-full mt-1 px-3 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-lg font-medium hover:shadow-lg transition-all text-sm">
                                    <i class="fas fa-wave-square mr-1"></i>分析周期
                                </button>
                            </div>
                        </div>
                        <button onclick="analyzeSingle()" class="w-full px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                            <i class="fas fa-play mr-2"></i>开始风格分析
                        </button>
                    </div>
                </section>

                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-orange-500/10 to-red-500/10">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-users text-orange-500"></i>
                            用户对比
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="text-sm font-medium">选择用户（至少2个）</label>
                            <div id="compare-targets" class="mt-2 space-y-2 max-h-40 overflow-y-auto">
                                <!-- 动态加载 -->
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium">时间范围</label>
                            <select id="compare-time-range" class="w-full mt-1 px-3 py-2 rounded-lg border bg-background">
                                <option value="week">最近一周</option>
                                <option value="month">最近一月</option>
                                <option value="all">全部历史</option>
                            </select>
                        </div>
                        <button onclick="compareUsers()" class="w-full px-4 py-2 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                            <i class="fas fa-chart-bar mr-2"></i>开始对比
                        </button>
                    </div>
                </section>

                <!-- 每日情绪分析 -->
                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-pink-500/10 to-rose-500/10">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-chart-line text-pink-500"></i>
                            每日情绪分析
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="p-4 rounded-xl bg-pink-50 dark:bg-pink-900/20 border border-pink-200 dark:border-pink-800">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-info-circle text-pink-500 mt-0.5"></i>
                                <div class="text-sm text-pink-700 dark:text-pink-300">
                                    <p class="font-medium">功能说明</p>
                                    <p class="mt-1">基于每天的回复内容，使用AI计算情绪指数（-1.0到1.0），用于绘制情绪趋势图。</p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium">选择用户</label>
                            <select id="daily-sentiment-target" class="w-full mt-1 px-3 py-2 rounded-lg border bg-background">
                                <option value="">请选择用户</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium">分析天数</label>
                            <select id="daily-sentiment-days" class="w-full mt-1 px-3 py-2 rounded-lg border bg-background">
                                <option value="7">最近7天</option>
                                <option value="14">最近14天</option>
                                <option value="30" selected>最近30天</option>
                                <option value="60">最近60天</option>
                                <option value="90">最近90天</option>
                            </select>
                        </div>
                        <button onclick="analyzeDailySentiment()" class="w-full px-4 py-2 bg-gradient-to-r from-pink-500 to-rose-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                            <i class="fas fa-heart-pulse mr-2"></i>开始情绪分析
                        </button>
                        <div id="daily-sentiment-status" class="hidden mt-4 p-4 rounded-xl bg-muted/50">
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-spinner fa-spin text-primary"></i>
                                <span id="daily-sentiment-status-text">分析中...</span>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- 右侧：历史报告 -->
            <div>
                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-blue-500/10 to-cyan-500/10">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-history text-blue-500"></i>
                            历史报告
                        </h2>
                    </div>
                    <div class="p-6">
                        <div id="reports-list" class="space-y-3 max-h-[600px] overflow-y-auto">
                            <!-- 动态加载 -->
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- 分析结果弹窗 -->
        <div id="result-modal" class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-card rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden">
                <div class="p-6 border-b flex items-center justify-between">
                    <h3 class="text-xl font-semibold" id="modal-title">分析报告</h3>
                    <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-muted transition-all">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto max-h-[60vh]" id="modal-content">
                    <!-- 动态内容 -->
                </div>
                <div class="p-6 border-t flex justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 bg-secondary rounded-lg hover:bg-secondary/80 transition-all">关闭</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 显示提示
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500'
            };
            alert.innerHTML = `
                <div class="${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-2 animate-in slide-in-from-right">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            alert.classList.remove('hidden');
            setTimeout(() => alert.classList.add('hidden'), 5000);
        }

        // 当前配置缓存
        let currentAIConfig = {};

        // 加载 AI 配置
        async function loadAIConfig() {
            try {
                const res = await fetch('/api/ai/config');
                const config = await res.json();
                currentAIConfig = config;
                
                const hasKey = config.api_key || config.api_key_masked;
                
                document.getElementById('ai-config').innerHTML = `
                    <div class="space-y-4">
                        <!-- 当前模型显示 -->
                        <div class="p-3 rounded-lg bg-gradient-to-r from-purple-500/10 to-indigo-500/10 border border-purple-200">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-robot text-purple-500"></i>
                                    <span class="text-sm font-medium">当前模型</span>
                                </div>
                                <span class="text-sm font-bold text-purple-600">${config.model || '未配置'}</span>
                            </div>
                            <div class="mt-2 text-xs text-muted-foreground flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full ${config.api_key ? 'bg-green-500' : 'bg-red-500'}"></span>
                                <span>${config.api_key ? 'API Key 已配置' : 'API Key 未配置'}</span>
                            </div>
                        </div>
                        
                        <!-- 提供商选择 -->
                        <div class="space-y-1">
                            <label class="text-sm font-medium">提供商</label>
                            <select id="ai-provider" class="w-full px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20" onchange="onProviderChange()">
                                <option value="kimi" ${(config.provider || 'kimi') === 'kimi' ? 'selected' : ''}>Kimi (Moonshot)</option>
                                <option value="openai" ${config.provider === 'openai' ? 'selected' : ''}>OpenAI</option>
                                <option value="custom" ${config.provider === 'custom' ? 'selected' : ''}>自定义</option>
                            </select>
                        </div>
                        
                        <!-- API Key 输入 -->
                        <div class="space-y-1">
                            <label class="text-sm font-medium">API Key</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <input type="password" id="ai-api-key" 
                                        value="${config.api_key || ''}" 
                                        placeholder="${config.api_key_masked || '输入 API Key'}"
                                        class="w-full px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20 pr-10">
                                    <button onclick="toggleApiKeyVisibility()" class="absolute right-2 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground">
                                        <i class="fas fa-eye" id="api-key-eye"></i>
                                    </button>
                                </div>
                            </div>
                            ${config.api_key_masked ? `<p class="text-xs text-muted-foreground">当前: ${config.api_key_masked}</p>` : ''}
                        </div>
                        
                        <!-- Base URL -->
                        <div class="space-y-1">
                            <label class="text-sm font-medium">Base URL</label>
                            <input type="url" id="ai-base-url" 
                                value="${config.base_url || 'https://api.moonshot.cn/v1'}" 
                                placeholder="https://api.moonshot.cn/v1"
                                class="w-full px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20">
                        </div>
                        
                        <!-- 模型选择 -->
                        <div class="space-y-1">
                            <div class="flex items-center justify-between">
                                <label class="text-sm font-medium">模型</label>
                                <button onclick="fetchAvailableModels()" class="text-xs text-primary hover:underline flex items-center gap-1">
                                    <i class="fas fa-sync-alt"></i> 获取可用模型
                                </button>
                            </div>
                            <div class="flex gap-2">
                                <select id="ai-model" class="flex-1 px-3 py-2 rounded-lg border bg-background text-sm focus:ring-2 focus:ring-primary/20">
                                    <option value="">加载中...</option>
                                </select>
                            </div>
                            <p id="model-loading" class="text-xs text-muted-foreground hidden">
                                <i class="fas fa-spinner fa-spin"></i> 正在获取模型列表...
                            </p>
                        </div>
                        
                        <!-- 操作按钮 -->
                        <div class="pt-4 border-t flex gap-2">
                            <button onclick="saveAIConfig()" class="flex-1 px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm font-medium hover:bg-primary/90 transition-all">
                                <i class="fas fa-save mr-1"></i> 保存配置
                            </button>
                            <button onclick="testAIConfig()" class="px-4 py-2 border rounded-lg text-sm font-medium hover:bg-muted transition-all">
                                <i class="fas fa-vial mr-1"></i> 测试
                            </button>
                        </div>
                    </div>
                `;
                
                // 初始化模型下拉框
                updateModelOptions(config.model || 'moonshot-v1-8k');
            } catch (e) {
                console.error('加载 AI 配置失败:', e);
                document.getElementById('ai-config').innerHTML = `
                    <div class="text-center py-4 text-muted-foreground">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p class="text-sm">加载配置失败</p>
                    </div>
                `;
            }
        }
        
        // 切换 API Key 显示/隐藏
        function toggleApiKeyVisibility() {
            const input = document.getElementById('ai-api-key');
            const icon = document.getElementById('api-key-eye');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        // 提供商改变时更新默认 Base URL
        function onProviderChange() {
            const provider = document.getElementById('ai-provider').value;
            const baseUrlInput = document.getElementById('ai-base-url');
            const modelSelect = document.getElementById('ai-model');
            
            const defaults = {
                'kimi': 'https://api.moonshot.cn/v1',
                'openai': 'https://api.openai.com/v1',
                'custom': ''
            };
            
            if (defaults[provider] && !baseUrlInput.value) {
                baseUrlInput.value = defaults[provider];
            }
            
            // 清空模型选择，等待获取
            modelSelect.innerHTML = '<option value="">点击"获取可用模型"按钮加载</option>';
        }
        
        // 更新模型选项
        function updateModelOptions(currentModel) {
            const select = document.getElementById('ai-model');
            const provider = document.getElementById('ai-provider')?.value || 'kimi';
            
            const defaultModels = {
                'kimi': [
                    { value: 'moonshot-v1-8k', label: 'moonshot-v1-8k (8K)' },
                    { value: 'moonshot-v1-32k', label: 'moonshot-v1-32k (32K)' },
                    { value: 'moonshot-v1-128k', label: 'moonshot-v1-128k (128K)' }
                ],
                'openai': [
                    { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo' },
                    { value: 'gpt-4', label: 'GPT-4' },
                    { value: 'gpt-4-turbo', label: 'GPT-4 Turbo' }
                ],
                'custom': [
                    { value: currentModel, label: currentModel || '自定义模型' }
                ]
            };
            
            const models = defaultModels[provider] || defaultModels['custom'];
            select.innerHTML = models.map(m => 
                `<option value="${m.value}" ${m.value === currentModel ? 'selected' : ''}>${m.label}</option>`
            ).join('');
        }
        
        // 获取可用模型列表
        async function fetchAvailableModels() {
            const provider = document.getElementById('ai-provider').value;
            const baseUrl = document.getElementById('ai-base-url').value;
            const apiKey = document.getElementById('ai-api-key').value;
            const loadingEl = document.getElementById('model-loading');
            const selectEl = document.getElementById('ai-model');
            
            if (!baseUrl || !apiKey) {
                showAlert('请先填写 Base URL 和 API Key', 'error');
                return;
            }
            
            loadingEl.classList.remove('hidden');
            selectEl.disabled = true;
            
            try {
                const res = await fetch('/api/ai/models', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider, base_url: baseUrl, api_key: apiKey })
                });
                
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || '获取模型失败');
                }
                
                const data = await res.json();
                
                // 更新模型下拉框
                const currentModel = selectEl.value;
                selectEl.innerHTML = data.models.map(m => 
                    `<option value="${m.id}" ${m.id === currentModel ? 'selected' : ''}>${m.id}</option>`
                ).join('');
                
                showAlert(`成功获取 ${data.models.length} 个可用模型`);
            } catch (e) {
                showAlert('获取模型失败: ' + e.message, 'error');
                console.error('获取模型失败:', e);
            } finally {
                loadingEl.classList.add('hidden');
                selectEl.disabled = false;
            }
        }
        
        // 保存 AI 配置
        async function saveAIConfig() {
            const config = {
                provider: document.getElementById('ai-provider').value,
                base_url: document.getElementById('ai-base-url').value,
                api_key: document.getElementById('ai-api-key').value,
                model: document.getElementById('ai-model').value
            };
            
            if (!config.model) {
                showAlert('请选择一个模型', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/ai/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                if (!res.ok) {
                    throw new Error('保存失败');
                }
                
                document.getElementById('config-status').textContent = '已保存';
                document.getElementById('config-status').className = 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-700';
                showAlert('配置保存成功');
                
                // 重新加载以更新 masked key 显示
                setTimeout(loadAIConfig, 500);
            } catch (e) {
                showAlert('保存配置失败: ' + e.message, 'error');
            }
        }
        
        // 测试 AI 配置
        async function testAIConfig() {
            const config = {
                provider: document.getElementById('ai-provider').value,
                base_url: document.getElementById('ai-base-url').value,
                api_key: document.getElementById('ai-api-key').value,
                model: document.getElementById('ai-model').value
            };
            
            showAlert('正在测试连接...', 'warning');
            
            try {
                // 简单的测试请求，验证 API Key 是否有效
                const res = await fetch('/api/ai/models', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        provider: config.provider, 
                        base_url: config.base_url, 
                        api_key: config.api_key 
                    })
                });
                
                if (res.ok) {
                    showAlert('连接测试成功！API Key 有效');
                } else {
                    const err = await res.json();
                    throw new Error(err.detail || '连接失败');
                }
            } catch (e) {
                showAlert('测试失败: ' + e.message, 'error');
            }
        }

        // 加载提示词模板
        async function loadTemplates() {
            try {
                const res = await fetch('/api/ai/templates');
                const data = await res.json();
                
                document.getElementById('templates-list').innerHTML = data.templates.map(t => `
                    <div class="p-3 rounded-lg border hover:bg-muted/50 transition-all cursor-pointer" onclick="viewTemplate('${t.id}')">
                        <div class="flex items-center justify-between">
                            <span class="font-medium">${t.name}</span>
                            <i class="fas fa-chevron-right text-muted-foreground text-sm"></i>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('加载模板失败:', e);
            }
        }

        // 加载监控目标
        async function loadTargets() {
            try {
                const res = await fetch('/api/targets');
                const data = await res.json();
                
                // 单用户选择
                document.getElementById('single-target').innerHTML = 
                    '<option value="">请选择用户</option>' +
                    data.targets.map(t => `<option value="${t.id}">${t.name || t.uid} (${t.uid})</option>`).join('');

                // 每日情绪分析用户选择
                document.getElementById('daily-sentiment-target').innerHTML = 
                    '<option value="">请选择用户</option>' +
                    data.targets.map(t => `<option value="${t.id}">${t.name || t.uid} (${t.uid})</option>`).join('');
                
                // 多用户选择
                document.getElementById('compare-targets').innerHTML = data.targets.map(t => `
                    <label class="flex items-center gap-2 p-2 rounded-lg border hover:bg-muted/50 cursor-pointer transition-all">
                        <input type="checkbox" value="${t.id}" class="compare-target-checkbox rounded">
                        <span class="text-sm">${t.name || t.uid}</span>
                    </label>
                `).join('');
            } catch (e) {
                console.error('加载目标失败:', e);
            }
        }

        // 加载历史报告
        async function loadReports() {
            try {
                const res = await fetch('/api/ai/reports');
                const data = await res.json();
                
                if (!data.reports || data.reports.length === 0) {
                    document.getElementById('reports-list').innerHTML = `
                        <div class="text-center py-8 text-muted-foreground">
                            <i class="fas fa-inbox text-4xl mb-2 opacity-50"></i>
                            <p>暂无分析报告</p>
                        </div>
                    `;
                    return;
                }
                
                document.getElementById('reports-list').innerHTML = data.reports.slice(0, 10).map(r => `
                    <div class="p-4 rounded-xl border hover:shadow-md transition-all cursor-pointer ${r.analysis_type === 'compare' ? 'bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20' : 'bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20'}" 
                         onclick="viewReport(${r.id})">
                        <div class="flex items-start justify-between">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-medium px-2 py-0.5 rounded-full ${r.analysis_type === 'compare' ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'}">
                                        ${r.analysis_type === 'compare' ? '对比' : '单用户'}
                                    </span>
                                    <span class="text-xs text-muted-foreground">${new Date(r.created_at).toLocaleDateString('zh-CN')}</span>
                                </div>
                                <p class="font-medium text-sm">${r.target_name || '未知用户'}</p>
                                <p class="text-xs text-muted-foreground mt-1">${r.summary ? r.summary.substring(0, 50) + '...' : '无摘要'}</p>
                            </div>
                            <button onclick="event.stopPropagation(); deleteReport(${r.id})" class="p-2 rounded-lg hover:bg-red-100 text-red-500 transition-all">
                                <i class="fas fa-trash-alt text-xs"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('加载报告失败:', e);
            }
        }

        // 单用户分析
        async function analyzeSingle() {
            const targetId = document.getElementById('single-target').value;
            const timeRange = document.getElementById('single-time-range').value;
            
            if (!targetId) {
                showAlert('请选择用户', 'error');
                return;
            }
            
            showAlert('分析中，请稍候...', 'warning');
            
            try {
                const res = await fetch(`/api/ai/analyze/${targetId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({time_range: timeRange})
                });
                
                if (res.ok) {
                    const data = await res.json();
                    showAlert('分析完成');
                    viewReport(data.report_id);
                    loadReports();
                } else {
                    const err = await res.json();
                    showAlert(err.detail || '分析失败', 'error');
                }
            } catch (e) {
                showAlert('请求失败', 'error');
            }
        }

        // 用户对比
        async function compareUsers() {
            const checkboxes = document.querySelectorAll('.compare-target-checkbox:checked');
            const targetIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            const timeRange = document.getElementById('compare-time-range').value;
            
            if (targetIds.length < 2) {
                showAlert('请至少选择 2 个用户', 'error');
                return;
            }
            
            showAlert('对比分析中，请稍候...', 'warning');
            
            try {
                const res = await fetch('/api/ai/compare', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({target_ids: targetIds, time_range: timeRange})
                });
                
                if (res.ok) {
                    const data = await res.json();
                    showAlert('对比完成');
                    viewReport(data.report_id);
                    loadReports();
                } else {
                    const err = await res.json();
                    showAlert(err.detail || '对比失败', 'error');
                }
            } catch (e) {
                showAlert('请求失败', 'error');
            }
        }

        // 查看报告
        async function viewReport(reportId) {
            try {
                const res = await fetch(`/api/ai/reports/${reportId}`);
                const data = await res.json();
                
                document.getElementById('modal-title').textContent = `${data.target_name} - 分析报告`;
                
                let content = '';
                if (data.report_content) {
                    const report = typeof data.report_content === 'string' ? JSON.parse(data.report_content) : data.report_content;
                    
                    content = `
                        <div class="space-y-6">
                            <div class="p-4 rounded-xl bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20">
                                <h4 class="font-semibold mb-2">总结</h4>
                                <p class="text-muted-foreground">${report.summary || '无'}</p>
                            </div>
                            
                            ${report.investment_style ? `
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-4 rounded-xl border">
                                    <span class="text-sm text-muted-foreground">投资风格</span>
                                    <p class="font-medium mt-1">${report.investment_style}</p>
                                </div>
                                <div class="p-4 rounded-xl border">
                                    <span class="text-sm text-muted-foreground">风险偏好</span>
                                    <p class="font-medium mt-1">${report.risk_preference}</p>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${report.focus_areas && report.focus_areas.length > 0 ? `
                            <div>
                                <h4 class="font-semibold mb-2">关注领域</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${report.focus_areas.map(area => `<span class="px-3 py-1 rounded-full bg-primary/10 text-primary text-sm">${area}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${report.recommendation ? `
                            <div class="p-4 rounded-xl bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20">
                                <h4 class="font-semibold mb-2">建议</h4>
                                <p class="text-muted-foreground">${report.recommendation}</p>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                document.getElementById('modal-content').innerHTML = content;
                document.getElementById('result-modal').classList.remove('hidden');
            } catch (e) {
                console.error('加载报告详情失败:', e);
                showAlert('加载报告失败', 'error');
            }
        }

        // 查看模板详情
        async function viewTemplate(templateId) {
            try {
                const res = await fetch(`/api/ai/templates/${templateId}`);
                const data = await res.json();
                
                document.getElementById('modal-title').textContent = data.name;
                document.getElementById('modal-content').innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-2">系统提示词</h4>
                            <pre class="p-4 rounded-lg bg-muted text-sm overflow-x-auto whitespace-pre-wrap">${data.system_prompt}</pre>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">分析提示词</h4>
                            <pre class="p-4 rounded-lg bg-muted text-sm overflow-x-auto whitespace-pre-wrap">${data.analysis_prompt}</pre>
                        </div>
                    </div>
                `;
                document.getElementById('result-modal').classList.remove('hidden');
            } catch (e) {
                showAlert('加载模板失败', 'error');
            }
        }

        // 删除报告
        async function deleteReport(reportId) {
            if (!confirm('确定要删除这份报告吗？')) return;
            
            try {
                const res = await fetch(`/api/ai/reports/${reportId}`, {method: 'DELETE'});
                if (res.ok) {
                    showAlert('报告已删除');
                    loadReports();
                }
            } catch (e) {
                showAlert('删除失败', 'error');
            }
        }

        // 关闭弹窗
        function closeModal() {
            document.getElementById('result-modal').classList.add('hidden');
        }

        // 情绪周期分析
        async function analyzeSentimentCycle() {
            const targetId = document.getElementById('single-target').value;
            const timeRange = document.getElementById('single-time-range').value;
            
            if (!targetId) {
                showAlert('请选择用户', 'error');
                return;
            }
            
            showAlert('正在分析情绪周期，请稍候...', 'warning');
            
            try {
                const days = timeRange === 'week' ? 7 : timeRange === 'month' ? 30 : 90;
                const res = await fetch(`/api/ai/sentiment-cycle/${targetId}?days=${days}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || '分析失败');
                }
                
                const data = await res.json();
                
                document.getElementById('modal-title').textContent = `${data.target_name} - 情绪周期分析`;
                document.getElementById('modal-content').innerHTML = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 text-white">
                                <p class="text-sm opacity-80">当前阶段</p>
                                <p class="text-2xl font-bold mt-1">${data.cycle_analysis.current_phase}</p>
                            </div>
                            <div class="p-4 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 text-white">
                                <p class="text-sm opacity-80">情绪指数</p>
                                <p class="text-2xl font-bold mt-1">${data.cycle_analysis.current_index}</p>
                            </div>
                        </div>
                        
                        <div class="p-4 rounded-lg bg-muted/50">
                            <h4 class="font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-robot text-primary"></i>AI 分析总结
                            </h4>
                            <p class="text-sm leading-relaxed">${data.cycle_analysis.summary}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold mb-2 text-sm">关键转折点</h4>
                                <ul class="space-y-1 text-sm">
                                    ${data.cycle_analysis.turning_points.map(tp => `
                                        <li class="flex items-center gap-2">
                                            <span class="w-2 h-2 rounded-full ${tp.type === 'peak' ? 'bg-green-500' : 'bg-red-500'}"></span>
                                            <span>${tp.date}: ${tp.description}</span>
                                        </li>
                                    `).join('') || '<li class="text-muted-foreground">暂无</li>'}
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2 text-sm">预测建议</h4>
                                <p class="text-sm text-muted-foreground">${data.cycle_analysis.prediction}</p>
                            </div>
                        </div>
                        
                        <div class="text-xs text-muted-foreground pt-2 border-t">
                            分析时间: ${new Date(data.created_at).toLocaleString('zh-CN')} | 置信度: ${(data.cycle_analysis.confidence * 100).toFixed(0)}%
                        </div>
                    </div>
                `;
                document.getElementById('result-modal').classList.remove('hidden');
                
            } catch (e) {
                showAlert('分析失败: ' + e.message, 'error');
            }
        }

        // 页面加载
        document.addEventListener('DOMContentLoaded', function() {
            loadAIConfig();
            loadTemplates();
            loadTargets();
            loadReports();
        });
    </script>
    </script>
</body>
</html>
