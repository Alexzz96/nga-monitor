<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGA Monitor - AI 分析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer base {
            :root {
                --background: 0 0% 100%;
                --foreground: 222.2 84% 4.9%;
                --card: 0 0% 100%;
                --card-foreground: 222.2 84% 4.9%;
                --popover: 0 0% 100%;
                --popover-foreground: 222.2 84% 4.9%;
                --primary: 221.2 83.2% 53.3%;
                --primary-foreground: 210 40% 98%;
                --secondary: 210 40% 96.1%;
                --secondary-foreground: 222.2 47.4% 11.2%;
                --muted: 210 40% 96.1%;
                --muted-foreground: 215.4 16.3% 46.9%;
                --accent: 210 40% 96.1%;
                --accent-foreground: 222.2 47.4% 11.2%;
                --destructive: 0 84.2% 60.2%;
                --destructive-foreground: 210 40% 98%;
                --border: 214.3 31.8% 91.4%;
                --input: 214.3 31.8% 91.4%;
                --ring: 221.2 83.2% 53.3%;
                --radius: 0.75rem;
            }
            .dark {
                --background: 222.2 84% 4.9%;
                --foreground: 210 40% 98%;
                --card: 222.2 84% 4.9%;
                --card-foreground: 210 40% 98%;
                --popover: 222.2 84% 4.9%;
                --popover-foreground: 210 40% 98%;
                --primary: 217.2 91.2% 59.8%;
                --primary-foreground: 222.2 47.4% 11.2%;
                --secondary: 217.2 32.6% 17.5%;
                --secondary-foreground: 210 40% 98%;
                --muted: 217.2 32.6% 17.5%;
                --muted-foreground: 215 20.2% 65.1%;
                --accent: 217.2 32.6% 17.5%;
                --accent-foreground: 210 40% 98%;
                --destructive: 0 62.8% 30.6%;
                --destructive-foreground: 210 40% 98%;
                --border: 217.2 32.6% 17.5%;
                --input: 217.2 32.6% 17.5%;
                --ring: 224.3 76.3% 48%;
            }
        }
        @layer base {
            * { @apply border-border; }
            body { @apply bg-background text-foreground; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800">
    <!-- 顶部导航 -->
    <nav class="sticky top-0 z-50 w-full border-b bg-white/80 dark:bg-slate-900/80 backdrop-blur-md">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-robot text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 dark:from-slate-100 dark:to-slate-300 bg-clip-text text-transparent">AI 分析</h1>
                    <p class="text-xs text-muted-foreground">智能投资风格分析</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <a href="/" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-muted-foreground hover:bg-secondary">
                    <i class="fas fa-satellite-dish mr-2"></i>监控
                </a>
                <a href="/ai" class="nav-btn active px-4 py-2 rounded-lg text-sm font-medium transition-all bg-primary text-primary-foreground shadow-md">
                    <i class="fas fa-robot mr-2"></i>AI分析
                </a>
                <a href="/data" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-muted-foreground hover:bg-secondary">
                    <i class="fas fa-database mr-2"></i>数据
                </a>
            </div>
        </div>
    </nav>

    <!-- 左侧悬浮导航 -->
    <div class="fixed left-4 top-1/2 -translate-y-1/2 z-40 flex flex-col gap-2 bg-card/90 backdrop-blur rounded-xl shadow-lg border p-2">
        <a href="/" class="w-10 h-10 rounded-lg hover:bg-muted flex items-center justify-center text-muted-foreground transition-all" title="监控">
            <i class="fas fa-satellite-dish"></i>
        </a>
        <a href="/ai" class="w-10 h-10 rounded-lg bg-primary text-primary-foreground flex items-center justify-center transition-all shadow-md" title="AI分析">
            <i class="fas fa-robot"></i>
        </a>
        <a href="/data" class="w-10 h-10 rounded-lg hover:bg-muted flex items-center justify-center text-muted-foreground transition-all" title="数据">
            <i class="fas fa-database"></i>
        </a>
        <a href="/analytics" class="w-10 h-10 rounded-lg hover:bg-muted flex items-center justify-center text-muted-foreground transition-all" title="情绪分析">
            <i class="fas fa-chart-line"></i>
        </a>
    </div>

    <main class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- 提示框 -->
        <div id="alert" class="hidden fixed top-20 right-4 z-50 max-w-md"></div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- 左侧：AI 配置 -->
            <div class="space-y-6">
                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-purple-500/10 to-pink-500/10">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-cog text-purple-500"></i>
                            AI 配置
                        </h2>
                    </div>
                    <div class="p-6 space-y-4" id="ai-config">
                        <!-- 动态加载 -->
                    </div>
                </section>

                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-file-alt text-blue-500"></i>
                            提示词模板
                        </h2>
                    </div>
                    <div class="p-6">
                        <div id="templates-list" class="space-y-2">
                            <!-- 动态加载 -->
                        </div>
                    </div>
                </section>
            </div>

            <!-- 中间：分析操作 -->
            <div class="space-y-6">
                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-green-500/10 to-emerald-500/10">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-user-check text-green-500"></i>
                            单用户分析
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="text-sm font-medium">选择用户</label>
                            <select id="single-target" class="w-full mt-1 px-3 py-2 rounded-lg border bg-background">
                                <!-- 动态加载 -->
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium">时间范围</label>
                            <select id="single-time-range" class="w-full mt-1 px-3 py-2 rounded-lg border bg-background">
                                <option value="week">最近一周</option>
                                <option value="month">最近一月</option>
                                <option value="all">全部历史</option>
                            </select>
                        </div>
                        <button onclick="analyzeSingle()" class="w-full px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                            <i class="fas fa-play mr-2"></i>开始分析
                        </button>
                    </div>
                </section>

                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-orange-500/10 to-red-500/10">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-users text-orange-500"></i>
                            用户对比
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="text-sm font-medium">选择用户（至少2个）</label>
                            <div id="compare-targets" class="mt-2 space-y-2 max-h-40 overflow-y-auto">
                                <!-- 动态加载 -->
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium">时间范围</label>
                            <select id="compare-time-range" class="w-full mt-1 px-3 py-2 rounded-lg border bg-background">
                                <option value="week">最近一周</option>
                                <option value="month">最近一月</option>
                                <option value="all">全部历史</option>
                            </select>
                        </div>
                        <button onclick="compareUsers()" class="w-full px-4 py-2 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                            <i class="fas fa-chart-bar mr-2"></i>开始对比
                        </button>
                    </div>
                </section>
            </div>

            <!-- 右侧：历史报告 -->
            <div>
                <section class="bg-card rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-6 border-b bg-gradient-to-r from-blue-500/10 to-cyan-500/10">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-history text-blue-500"></i>
                            历史报告
                        </h2>
                    </div>
                    <div class="p-6">
                        <div id="reports-list" class="space-y-3 max-h-[600px] overflow-y-auto">
                            <!-- 动态加载 -->
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- 分析结果弹窗 -->
        <div id="result-modal" class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-card rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden">
                <div class="p-6 border-b flex items-center justify-between">
                    <h3 class="text-xl font-semibold" id="modal-title">分析报告</h3>
                    <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-muted transition-all">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto max-h-[60vh]" id="modal-content">
                    <!-- 动态内容 -->
                </div>
                <div class="p-6 border-t flex justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 bg-secondary rounded-lg hover:bg-secondary/80 transition-all">关闭</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 显示提示
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500'
            };
            alert.innerHTML = `
                <div class="${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-2 animate-in slide-in-from-right">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            alert.classList.remove('hidden');
            setTimeout(() => alert.classList.add('hidden'), 5000);
        }

        // 加载 AI 配置
        async function loadAIConfig() {
            try {
                const res = await fetch('/api/ai/config');
                const config = await res.json();
                
                document.getElementById('ai-config').innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 rounded-lg bg-muted/50">
                            <span class="text-sm text-muted-foreground">提供商</span>
                            <span class="font-medium">${config.provider || 'kimi'}</span>
                        </div>
                        <div class="flex items-center justify-between p-3 rounded-lg bg-muted/50">
                            <span class="text-sm text-muted-foreground">模型</span>
                            <span class="font-medium">${config.model || 'moonshot-v1-8k'}</span>
                        </div>
                        <div class="flex items-center justify-between p-3 rounded-lg bg-muted/50">
                            <span class="text-sm text-muted-foreground">API Key</span>
                            <span class="font-medium">${config.api_key_masked || '未配置'}</span>
                        </div>
                    </div>
                    <div class="pt-4 border-t">
                        <p class="text-xs text-muted-foreground">如需修改配置，请通过 API 或直接修改数据库</p>
                    </div>
                `;
            } catch (e) {
                console.error('加载 AI 配置失败:', e);
            }
        }

        // 加载提示词模板
        async function loadTemplates() {
            try {
                const res = await fetch('/api/ai/templates');
                const data = await res.json();
                
                document.getElementById('templates-list').innerHTML = data.templates.map(t => `
                    <div class="p-3 rounded-lg border hover:bg-muted/50 transition-all cursor-pointer" onclick="viewTemplate('${t.id}')">
                        <div class="flex items-center justify-between">
                            <span class="font-medium">${t.name}</span>
                            <i class="fas fa-chevron-right text-muted-foreground text-sm"></i>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('加载模板失败:', e);
            }
        }

        // 加载监控目标
        async function loadTargets() {
            try {
                const res = await fetch('/api/targets');
                const data = await res.json();
                
                // 单用户选择
                document.getElementById('single-target').innerHTML = 
                    '<option value="">请选择用户</option>' +
                    data.targets.map(t => `<option value="${t.id}">${t.name || t.uid} (${t.uid})</option>`).join('');
                
                // 多用户选择
                document.getElementById('compare-targets').innerHTML = data.targets.map(t => `
                    <label class="flex items-center gap-2 p-2 rounded-lg border hover:bg-muted/50 cursor-pointer transition-all">
                        <input type="checkbox" value="${t.id}" class="compare-target-checkbox rounded">
                        <span class="text-sm">${t.name || t.uid}</span>
                    </label>
                `).join('');
            } catch (e) {
                console.error('加载目标失败:', e);
            }
        }

        // 加载历史报告
        async function loadReports() {
            try {
                const res = await fetch('/api/ai/reports');
                const data = await res.json();
                
                if (!data.reports || data.reports.length === 0) {
                    document.getElementById('reports-list').innerHTML = `
                        <div class="text-center py-8 text-muted-foreground">
                            <i class="fas fa-inbox text-4xl mb-2 opacity-50"></i>
                            <p>暂无分析报告</p>
                        </div>
                    `;
                    return;
                }
                
                document.getElementById('reports-list').innerHTML = data.reports.slice(0, 10).map(r => `
                    <div class="p-4 rounded-xl border hover:shadow-md transition-all cursor-pointer ${r.analysis_type === 'compare' ? 'bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20' : 'bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20'}" 
                         onclick="viewReport(${r.id})">
                        <div class="flex items-start justify-between">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-medium px-2 py-0.5 rounded-full ${r.analysis_type === 'compare' ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'}">
                                        ${r.analysis_type === 'compare' ? '对比' : '单用户'}
                                    </span>
                                    <span class="text-xs text-muted-foreground">${new Date(r.created_at).toLocaleDateString('zh-CN')}</span>
                                </div>
                                <p class="font-medium text-sm">${r.target_name || '未知用户'}</p>
                                <p class="text-xs text-muted-foreground mt-1">${r.summary ? r.summary.substring(0, 50) + '...' : '无摘要'}</p>
                            </div>
                            <button onclick="event.stopPropagation(); deleteReport(${r.id})" class="p-2 rounded-lg hover:bg-red-100 text-red-500 transition-all">
                                <i class="fas fa-trash-alt text-xs"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('加载报告失败:', e);
            }
        }

        // 单用户分析
        async function analyzeSingle() {
            const targetId = document.getElementById('single-target').value;
            const timeRange = document.getElementById('single-time-range').value;
            
            if (!targetId) {
                showAlert('请选择用户', 'error');
                return;
            }
            
            showAlert('分析中，请稍候...', 'warning');
            
            try {
                const res = await fetch(`/api/ai/analyze/${targetId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({time_range: timeRange})
                });
                
                if (res.ok) {
                    const data = await res.json();
                    showAlert('分析完成');
                    viewReport(data.report_id);
                    loadReports();
                } else {
                    const err = await res.json();
                    showAlert(err.detail || '分析失败', 'error');
                }
            } catch (e) {
                showAlert('请求失败', 'error');
            }
        }

        // 用户对比
        async function compareUsers() {
            const checkboxes = document.querySelectorAll('.compare-target-checkbox:checked');
            const targetIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            const timeRange = document.getElementById('compare-time-range').value;
            
            if (targetIds.length < 2) {
                showAlert('请至少选择 2 个用户', 'error');
                return;
            }
            
            showAlert('对比分析中，请稍候...', 'warning');
            
            try {
                const res = await fetch('/api/ai/compare', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({target_ids: targetIds, time_range: timeRange})
                });
                
                if (res.ok) {
                    const data = await res.json();
                    showAlert('对比完成');
                    viewReport(data.report_id);
                    loadReports();
                } else {
                    const err = await res.json();
                    showAlert(err.detail || '对比失败', 'error');
                }
            } catch (e) {
                showAlert('请求失败', 'error');
            }
        }

        // 查看报告
        async function viewReport(reportId) {
            try {
                const res = await fetch(`/api/ai/reports/${reportId}`);
                const data = await res.json();
                
                document.getElementById('modal-title').textContent = `${data.target_name} - 分析报告`;
                
                let content = '';
                if (data.report_content) {
                    const report = typeof data.report_content === 'string' ? JSON.parse(data.report_content) : data.report_content;
                    
                    content = `
                        <div class="space-y-6">
                            <div class="p-4 rounded-xl bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20">
                                <h4 class="font-semibold mb-2">总结</h4>
                                <p class="text-muted-foreground">${report.summary || '无'}</p>
                            </div>
                            
                            ${report.investment_style ? `
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-4 rounded-xl border">
                                    <span class="text-sm text-muted-foreground">投资风格</span>
                                    <p class="font-medium mt-1">${report.investment_style}</p>
                                </div>
                                <div class="p-4 rounded-xl border">
                                    <span class="text-sm text-muted-foreground">风险偏好</span>
                                    <p class="font-medium mt-1">${report.risk_preference}</p>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${report.focus_areas && report.focus_areas.length > 0 ? `
                            <div>
                                <h4 class="font-semibold mb-2">关注领域</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${report.focus_areas.map(area => `<span class="px-3 py-1 rounded-full bg-primary/10 text-primary text-sm">${area}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${report.recommendation ? `
                            <div class="p-4 rounded-xl bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20">
                                <h4 class="font-semibold mb-2">建议</h4>
                                <p class="text-muted-foreground">${report.recommendation}</p>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                document.getElementById('modal-content').innerHTML = content;
                document.getElementById('result-modal').classList.remove('hidden');
            } catch (e) {
                console.error('加载报告详情失败:', e);
                showAlert('加载报告失败', 'error');
            }
        }

        // 查看模板详情
        async function viewTemplate(templateId) {
            try {
                const res = await fetch(`/api/ai/templates/${templateId}`);
                const data = await res.json();
                
                document.getElementById('modal-title').textContent = data.name;
                document.getElementById('modal-content').innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-2">系统提示词</h4>
                            <pre class="p-4 rounded-lg bg-muted text-sm overflow-x-auto whitespace-pre-wrap">${data.system_prompt}</pre>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">分析提示词</h4>
                            <pre class="p-4 rounded-lg bg-muted text-sm overflow-x-auto whitespace-pre-wrap">${data.analysis_prompt}</pre>
                        </div>
                    </div>
                `;
                document.getElementById('result-modal').classList.remove('hidden');
            } catch (e) {
                showAlert('加载模板失败', 'error');
            }
        }

        // 删除报告
        async function deleteReport(reportId) {
            if (!confirm('确定要删除这份报告吗？')) return;
            
            try {
                const res = await fetch(`/api/ai/reports/${reportId}`, {method: 'DELETE'});
                if (res.ok) {
                    showAlert('报告已删除');
                    loadReports();
                }
            } catch (e) {
                showAlert('删除失败', 'error');
            }
        }

        // 关闭弹窗
        function closeModal() {
            document.getElementById('result-modal').classList.add('hidden');
        }

        // 页面加载
        document.addEventListener('DOMContentLoaded', function() {
            loadAIConfig();
            loadTemplates();
            loadTargets();
            loadReports();
        });
    </script>
</body>
</html>
