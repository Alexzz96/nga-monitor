<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGA Monitor - AI åˆ†æ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #9b59b6;
            padding-bottom: 10px;
        }
        .nav {
            margin-bottom: 20px;
        }
        .nav a {
            color: #3498db;
            text-decoration: none;
            margin-right: 20px;
        }
        .nav a:hover {
            text-decoration: none;
        }
        .nav-btn {
            padding: 8px 16px;
            border-radius: 4px;
            background: #f8f9fa;
            color: #555;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            margin-right: 0;
        }
        .nav-btn:hover {
            background: #e9ecef;
        }
        .nav-btn.active {
            background: #9b59b6;
            color: white;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #34495e;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        input[type="text"], input[type="url"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #9b59b6;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #9b59b6;
            color: white;
        }
        .btn-primary:hover { background: #8e44ad; }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-success:hover { background: #229954; }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-danger:hover { background: #c0392b; }
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        .btn-secondary:hover { background: #7f8c8d; }
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        .flex {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .flex-grow { flex: 1; }
        .hidden { display: none; }
        .alert {
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
        }
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
        }
        .checkbox-item:hover {
            background: #e9ecef;
        }
        .checkbox-item input {
            cursor: pointer;
        }
        .report-card {
            background: #f8f9fa;
            border-left: 4px solid #9b59b6;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .report-card h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .tag-purple {
            background: #e8daef;
            color: #6c3483;
        }
        .tag-blue {
            background: #d6eaf8;
            color: #2874a6;
        }
        .tag-green {
            background: #d5f4e6;
            color: #1e8449;
        }
        .tag-orange {
            background: #fdebd0;
            color: #b7950b;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .loading.active {
            display: block;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #9b59b6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– AI åˆ†æä¸­å¿ƒ</h1>
        
        <div class="nav" style="margin-bottom: 20px; display: flex; gap: 10px;">
            <a href="/" class="nav-btn">ğŸ“¡ ç›‘æ§ç®¡ç†</a>
            <a href="/ai" class="nav-btn active">ğŸ¤– AI åˆ†æ</a>
            <a href="/data" class="nav-btn">ğŸ“Š æ•°æ®ç®¡ç†</a>
        </div>
        
        <div id="alert" class="alert hidden"></div>
        
        <!-- AI é…ç½® -->
        <div class="card">
            <h2>âš™ï¸ AI é…ç½®</h2>
            
            <div class="grid-2">
                <div class="form-group">
                    <label>AI æä¾›å•†</label>
                    <select id="ai-provider">
                        <option value="kimi">Kimi (Moonshot)</option>
                        <option value="openai">OpenAI</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>æ¨¡å‹åç§°</label>
                    <div class="flex">
                        <input type="text" id="ai-model" placeholder="moonshot-v1-8k æˆ– gpt-4" class="flex-grow">
                        <button type="button" class="btn btn-secondary" onclick="fetchModels()" style="margin-left: 10px; white-space: nowrap;">è·å–å¯ç”¨æ¨¡å‹</button>
                    </div>
                </div>
            </div>
            
            <!-- æ¨¡å‹é€‰æ‹©å¼¹çª— -->
            <div id="models-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: white; padding: 20px; border-radius: 8px; max-width: 500px; max-height: 70vh; width: 90%; overflow: auto;">
                    <h3 style="margin-bottom: 15px;">é€‰æ‹©æ¨¡å‹</h3>
                    <div id="models-list" style="margin-bottom: 15px;">
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                    <button class="btn btn-secondary" onclick="closeModelsModal()">å…³é—­</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>API Base URL</label>
                <input type="url" id="ai-base-url" placeholder="https://api.moonshot.cn/v1">
            </div>
            
            <div class="form-group">
                <label>API Key</label>
                <input type="text" id="ai-api-key" placeholder="è¾“å…¥ä½ çš„ API Key">
                <p style="font-size: 12px; color: #666; margin-top: 5px;"
                   id="api-key-hint">å¦‚æœå·²é…ç½®ï¼Œç•™ç©ºåˆ™ä¿æŒåŸæœ‰è®¾ç½®</p>
            </div>
            
            <!-- æç¤ºè¯æ¨¡æ¿é€‰æ‹© -->
            <div class="form-group" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #9b59b6;">
                <label style="color: #9b59b6; font-weight: bold;">ğŸ“ æç¤ºè¯æ¨¡æ¿ï¼ˆå¿«é€Ÿé…ç½®ï¼‰</label>
                <div class="flex" style="margin-top: 10px;">
                    <select id="prompt-template" class="flex-grow" onchange="applyPromptTemplate()">
                        <option value="">-- é€‰æ‹©æ¨¡æ¿ --</option>
                    </select>
                    <button type="button" class="btn btn-secondary" onclick="loadPromptTemplates()" style="margin-left: 10px;">åˆ·æ–°</button>
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 8px;">
                    é€‰æ‹©æ¨¡æ¿å°†è‡ªåŠ¨å¡«å……ä¸‹æ–¹çš„ç³»ç»Ÿæç¤ºè¯å’Œåˆ†ææç¤ºè¯ã€‚æ‚¨ä¹Ÿå¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šæ‰‹åŠ¨ä¿®æ”¹ã€‚
                </p>
            </div>
            
            <div class="form-group">
                <label>ç³»ç»Ÿæç¤ºè¯ (System Prompt)</label>
                <textarea id="ai-system-prompt" placeholder="å®šä¹‰ AI çš„è§’è‰²å’ŒåŸºæœ¬è¡Œä¸º..."></textarea>
            </div>
            
            <div class="form-group">
                <label>åˆ†ææç¤ºè¯ (Analysis Prompt)</label>
                <textarea id="ai-analysis-prompt" placeholder="å®šä¹‰åˆ†æä»»åŠ¡çš„å…·ä½“è¦æ±‚..."></textarea>
                <p style="font-size: 12px; color: #666; margin-top: 5px;"
                   >å¯ç”¨å˜é‡: {user_name} (ç”¨æˆ·å), {content} (å›å¤å†…å®¹)</p>
            </div>
            
            <div class="flex">
                <button class="btn btn-primary" onclick="saveAIConfig()">ä¿å­˜é…ç½®</button>
                <button class="btn btn-secondary" onclick="loadAIConfig()">åˆ·æ–°é…ç½®</button>
            </div>
        </div>
        
        <!-- å•ç”¨æˆ·åˆ†æ -->
        <div class="card">
            <h2>ğŸ‘¤ å•ç”¨æˆ·åˆ†æ</h2>
            
            <div class="form-group">
                <label>é€‰æ‹©ç›‘æ§ç›®æ ‡</label>
                <div class="checkbox-group" id="single-targets">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="form-group">
                <label>æ—¶é—´èŒƒå›´</label>
                <select id="single-time-range">
                    <option value="week">æœ¬å‘¨ (æœ€è¿‘7å¤©)</option>
                    <option value="month">æœ¬æœˆ (æœ€è¿‘30å¤©)</option>
                    <option value="all">å…¨éƒ¨å†å²</option>
                </select>
            </div>
            
            <button class="btn btn-success" onclick="analyzeSingle()">å¼€å§‹åˆ†æ</button>
            
            <div class="loading" id="single-loading">
                <div class="spinner"></div>
                <p>AI æ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...</p>
            </div>
            
            <div id="single-result"></div>
        </div>
        
        <!-- å¤šç”¨æˆ·å¯¹æ¯” -->
        <div class="card">
            <h2>ğŸ‘¥ å¤šç”¨æˆ·å¯¹æ¯”</h2>
            
            <div class="form-group">
                <label>é€‰æ‹©å¯¹æ¯”ç”¨æˆ·ï¼ˆè‡³å°‘2ä¸ªï¼‰</label>
                <div class="checkbox-group" id="compare-targets">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="form-group">
                <label>æ—¶é—´èŒƒå›´</label>
                <select id="compare-time-range">
                    <option value="week">æœ¬å‘¨ (æœ€è¿‘7å¤©)</option>
                    <option value="month">æœ¬æœˆ (æœ€è¿‘30å¤©)</option>
                    <option value="all">å…¨éƒ¨å†å²</option>
                </select>
            </div>
            
            <button class="btn btn-success" onclick="analyzeCompare()">å¼€å§‹å¯¹æ¯”</button>
            
            <div class="loading" id="compare-loading">
                <div class="spinner"></div>
                <p>AI æ­£åœ¨å¯¹æ¯”åˆ†æä¸­ï¼Œè¯·ç¨å€™...</p>
            </div>
            
            <div id="compare-result"></div>
        </div>
        
        <!-- å†å²æŠ¥å‘Š -->
        <div class="card">
            <h2>ğŸ“š å†å²åˆ†ææŠ¥å‘Š</h2>
            <div id="reports-list">
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>
    
    <script>
        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            loadAIConfig();
            loadTargets();
            loadReports();
            loadPromptTemplates();
        });

        // ========== æç¤ºè¯æ¨¡æ¿ ==========

        async function loadPromptTemplates() {
            try {
                const res = await fetch('/api/ai/templates');
                const data = await res.json();

                const select = document.getElementById('prompt-template');
                // ä¿ç•™ç¬¬ä¸€ä¸ªé€‰é¡¹
                const firstOption = select.options[0];
                select.innerHTML = '';
                select.appendChild(firstOption);

                for (const template of data.templates) {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    select.appendChild(option);
                }
            } catch (e) {
                console.error('åŠ è½½æ¨¡æ¿å¤±è´¥:', e);
            }
        }

        async function applyPromptTemplate() {
            const templateId = document.getElementById('prompt-template').value;
            if (!templateId) return;

            if (!confirm('åº”ç”¨æ¨¡æ¿å°†è¦†ç›–å½“å‰çš„ç³»ç»Ÿæç¤ºè¯å’Œåˆ†ææç¤ºè¯ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                document.getElementById('prompt-template').value = '';
                return;
            }

            try {
                const res = await fetch(`/api/ai/templates/${templateId}`);
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('ai-system-prompt').value = data.system_prompt;
                    document.getElementById('ai-analysis-prompt').value = data.analysis_prompt;
                    showAlert(`å·²åº”ç”¨æ¨¡æ¿ï¼š${data.name}`);
                } else {
                    showAlert('åŠ è½½æ¨¡æ¿å¤±è´¥', 'error');
                }
            } catch (e) {
                showAlert('è¯·æ±‚å¤±è´¥', 'error');
            }
        }
        
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert alert-' + type;
            alert.classList.remove('hidden');
            setTimeout(() => alert.classList.add('hidden'), 5000);
        }
        
        // ========== AI é…ç½® ==========
        
        async function loadAIConfig() {
            try {
                const res = await fetch('/api/ai/config');
                const config = await res.json();
                
                document.getElementById('ai-provider').value = config.provider || 'kimi';
                document.getElementById('ai-model').value = config.model || '';
                document.getElementById('ai-base-url').value = config.base_url || '';
                document.getElementById('ai-system-prompt').value = config.system_prompt || '';
                document.getElementById('ai-analysis-prompt').value = config.analysis_prompt || '';
                
                if (config.api_key_masked) {
                    document.getElementById('ai-api-key').placeholder = `å·²é…ç½®: ${config.api_key_masked}`;
                }
            } catch (e) {
                console.error('åŠ è½½ AI é…ç½®å¤±è´¥:', e);
            }
        }
        
        async function saveAIConfig() {
            const apiKey = document.getElementById('ai-api-key').value.trim();
            
            const config = {
                provider: document.getElementById('ai-provider').value,
                model: document.getElementById('ai-model').value.trim(),
                base_url: document.getElementById('ai-base-url').value.trim(),
                system_prompt: document.getElementById('ai-system-prompt').value.trim(),
                analysis_prompt: document.getElementById('ai-analysis-prompt').value.trim()
            };
            
            // å¦‚æœæœ‰è¾“å…¥æ–°çš„ API Keyï¼Œåˆ™æ›´æ–°
            if (apiKey) {
                config.api_key = apiKey;
            }
            
            try {
                const res = await fetch('/api/ai/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                
                if (res.ok) {
                    showAlert('AI é…ç½®å·²ä¿å­˜');
                    document.getElementById('ai-api-key').value = '';
                    loadAIConfig();
                } else {
                    showAlert('ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (e) {
                showAlert('è¯·æ±‚å¤±è´¥', 'error');
            }
        }
        
        // ========== è·å–å¯ç”¨æ¨¡å‹ ==========
        
        async function fetchModels() {
            const baseUrl = document.getElementById('ai-base-url').value.trim();
            const apiKey = document.getElementById('ai-api-key').value.trim();
            const provider = document.getElementById('ai-provider').value;
            
            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('models-modal').style.display = 'flex';
            document.getElementById('models-list').innerHTML = '<div class="spinner"></div><p>æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...</p>';
            
            try {
                const res = await fetch('/api/ai/models', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider: provider,
                        base_url: baseUrl,
                        api_key: apiKey
                    })
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    renderModelsList(data.models);
                } else {
                    document.getElementById('models-list').innerHTML = `
                        <div class="alert alert-error">
                            <strong>è·å–å¤±è´¥:</strong> ${data.detail || 'æœªçŸ¥é”™è¯¯'}
                        </div>
                    `;
                }
            } catch (e) {
                document.getElementById('models-list').innerHTML = `
                    <div class="alert alert-error">
                        <strong>è¯·æ±‚å¤±è´¥:</strong> ${e.message}
                    </div>
                `;
            }
        }
        
        function renderModelsList(models) {
            if (models.length === 0) {
                document.getElementById('models-list').innerHTML = '<p>æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹</p>';
                return;
            }
            
            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            
            models.forEach(model => {
                html += `
                    <div style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;" 
                         onmouseover="this.style.background='#f5f5f5'" 
                         onmouseout="this.style.background='white'"
                         onclick="selectModel('${model.id}')">
                        <strong>${model.id}</strong>
                        <span style="color: #666; font-size: 12px; margin-left: 10px;">${model.owned_by}</span>
                    </div>
                `;
            });
            
            html += '</div>';
            html += `<p style="margin-top: 10px; font-size: 12px; color: #666;">å…± ${models.length} ä¸ªæ¨¡å‹ï¼Œç‚¹å‡»é€‰æ‹©</p>`;
            
            document.getElementById('models-list').innerHTML = html;
        }
        
        function selectModel(modelId) {
            document.getElementById('ai-model').value = modelId;
            closeModelsModal();
            showAlert(`å·²é€‰æ‹©æ¨¡å‹: ${modelId}`);
        }
        
        function closeModelsModal() {
            document.getElementById('models-modal').style.display = 'none';
        }
        
        // ========== ç›®æ ‡é€‰æ‹© ==========
        
        async function loadTargets() {
            try {
                const res = await fetch('/api/targets');
                const data = await res.json();
                
                const singleContainer = document.getElementById('single-targets');
                const compareContainer = document.getElementById('compare-targets');
                const archiveContainer = document.getElementById('archive-targets');
                
                const html = data.targets.map(t => `
                    <label class="checkbox-item">
                        <input type="radio" name="single-target" value="${t.id}" data-name="${t.name}">
                        <span>${t.name || t.uid}</span>
                    </label>
                `).join('');
                
                singleContainer.innerHTML = html;
                
                const compareHtml = data.targets.map(t => `
                    <label class="checkbox-item">
                        <input type="checkbox" name="compare-target" value="${t.id}" data-name="${t.name}">
                        <span>${t.name || t.uid}</span>
                    </label>
                `).join('');
                
                compareContainer.innerHTML = compareHtml;
                
            } catch (e) {
                console.error('åŠ è½½ç›®æ ‡å¤±è´¥:', e);
            }
        }
        
        // ========== å•ç”¨æˆ·åˆ†æ ==========
        
        async function analyzeSingle() {
            const selected = document.querySelector('input[name="single-target"]:checked');
            if (!selected) {
                showAlert('è¯·é€‰æ‹©ä¸€ä¸ªç›‘æ§ç›®æ ‡', 'error');
                return;
            }
            
            const targetId = parseInt(selected.value);
            const timeRange = document.getElementById('single-time-range').value;
            
            document.getElementById('single-loading').classList.add('active');
            document.getElementById('single-result').innerHTML = '';
            
            try {
                const res = await fetch(`/api/ai/analyze/${targetId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({time_range: timeRange})
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    renderSingleResult(data);
                    loadReports();
                } else {
                    showAlert(data.detail || 'åˆ†æå¤±è´¥', 'error');
                }
            } catch (e) {
                showAlert('è¯·æ±‚å¤±è´¥', 'error');
            } finally {
                document.getElementById('single-loading').classList.remove('active');
            }
        }
        
        function renderSingleResult(data) {
            const analysis = data.analysis;
            let html = `
                <div class="report-card">
                    <h4>ğŸ“Š ${data.target_name} - ${data.time_range === 'week' ? 'æœ¬å‘¨' : data.time_range === 'month' ? 'æœ¬æœˆ' : 'å…¨éƒ¨'}åˆ†ææŠ¥å‘Š</h4>
                    <p><strong>æ•´ä½“è¯„ä»·:</strong> ${analysis.summary || 'æ— '}</p>
                    <p><strong>æŠ•èµ„é£æ ¼:</strong> ${analysis.investment_style || 'æœªçŸ¥'}</p>
                    <p><strong>é£é™©åå¥½:</strong> ${analysis.risk_preference || 'æœªçŸ¥'}</p>
                    <p><strong>æƒ…ç»ªå€¾å‘:</strong> ${analysis.sentiment || 'æœªçŸ¥'}</p>
                    
                    <p style="margin-top: 10px;"><strong>å…³æ³¨é¢†åŸŸ:</strong></p>
                    <div>
                        ${(analysis.focus_areas || []).map(a => `<span class="tag tag-purple">${a}</span>`).join('')}
                    </div>
                    
                    <p style="margin-top: 10px;"><strong>æåŠæ ‡çš„:</strong></p>
                    <div>
                        ${(analysis.key_stocks || []).map(s => `<span class="tag tag-blue">${s}</span>`).join('')}
                    </div>
                    
                    <p style="margin-top: 10px;"><strong>ç‰¹ç‚¹æ ‡ç­¾:</strong></p>
                    <div>
                        ${(analysis.characteristics || []).map(c => `<span class="tag tag-green">${c}</span>`).join('')}
                    </div>
                    
                    ${analysis.recommendation ? `<p style="margin-top: 10px;"><strong>å»ºè®®:</strong> ${analysis.recommendation}</p>` : ''}
                </div>
            `;
            
            document.getElementById('single-result').innerHTML = html;
        }
        
        // ========== å¤šç”¨æˆ·å¯¹æ¯” ==========
        
        async function analyzeCompare() {
            const selected = document.querySelectorAll('input[name="compare-target"]:checked');
            if (selected.length < 2) {
                showAlert('è¯·è‡³å°‘é€‰æ‹© 2 ä¸ªç›‘æ§ç›®æ ‡', 'error');
                return;
            }
            
            const targetIds = Array.from(selected).map(s => parseInt(s.value));
            const timeRange = document.getElementById('compare-time-range').value;
            
            document.getElementById('compare-loading').classList.add('active');
            document.getElementById('compare-result').innerHTML = '';
            
            try {
                const res = await fetch('/api/ai/compare', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({target_ids: targetIds, time_range: timeRange})
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    renderCompareResult(data);
                    loadReports();
                } else {
                    showAlert(data.detail || 'å¯¹æ¯”åˆ†æå¤±è´¥', 'error');
                }
            } catch (e) {
                showAlert('è¯·æ±‚å¤±è´¥', 'error');
            } finally {
                document.getElementById('compare-loading').classList.remove('active');
            }
        }
        
        function renderCompareResult(data) {
            const analysis = data.analysis;
            let html = `
                <div class="report-card">
                    <h4>ğŸ“Š å¯¹æ¯”åˆ†æ: ${data.users.join(' vs ')}</h4>
                    <p><strong>æ•´ä½“æ€»ç»“:</strong> ${analysis.summary || 'æ— '}</p>
                    
                    ${analysis.comparisons ? analysis.comparisons.map(c => `
                        <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 4px;">
                            <p><strong>${c.user}</strong></p>
                            <p>é£æ ¼: ${c.style || 'æœªçŸ¥'}</p>
                            ${c.strengths ? `<p>ä¼˜åŠ¿: ${c.strengths.join(', ')}</p>` : ''}
                            ${c.weaknesses ? `<p>ä¸è¶³: ${c.weaknesses.join(', ')}</p>` : ''}
                        </div>
                    `).join('') : ''}
                    
                    ${analysis.similarities ? `
                        <p style="margin-top: 10px;"><strong>å…±åŒç‚¹:</strong></p>
                        <ul>${analysis.similarities.map(s => `<li>${s}</li>`).join('')}</ul>
                    ` : ''}
                    
                    ${analysis.differences ? `
                        <p style="margin-top: 10px;"><strong>å·®å¼‚ç‚¹:</strong></p>
                        <ul>${analysis.differences.map(d => `<li>${d}</li>`).join('')}</ul>
                    ` : ''}
                    
                    ${analysis.recommendations ? `<p style="margin-top: 10px;"><strong>å»ºè®®:</strong> ${analysis.recommendations}</p>` : ''}
                </div>
            `;
            
            document.getElementById('compare-result').innerHTML = html;
        }
        
        // ========== å†å²æŠ¥å‘Š ==========
        
        async function loadReports() {
            try {
                const res = await fetch('/api/ai/reports?limit=10');
                const data = await res.json();
                
                if (data.reports.length === 0) {
                    document.getElementById('reports-list').innerHTML = '<p>æš‚æ— åˆ†ææŠ¥å‘Š</p>';
                    return;
                }
                
                const html = data.reports.map(r => `
                    <div class="report-card" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>${r.target_name} - ${r.time_range === 'week' ? 'æœ¬å‘¨' : r.time_range === 'month' ? 'æœ¬æœˆ' : 'å…¨éƒ¨'}${r.analysis_type === 'compare' ? 'å¯¹æ¯”' : ''}åˆ†æ</h4>
                            <p style="font-size: 12px; color: #666;">
                                ${new Date(r.created_at).toLocaleString()} | 
                                ${r.summary ? r.summary.substring(0, 100) + '...' : 'æ— æ‘˜è¦'}
                            </p>
                        </div>
                        <div>
                            <button class="btn btn-secondary btn-sm" onclick="viewReport(${r.id})">æŸ¥çœ‹</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteReport(${r.id})">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('reports-list').innerHTML = html;
            } catch (e) {
                console.error('åŠ è½½æŠ¥å‘Šå¤±è´¥:', e);
            }
        }
        
        async function viewReport(reportId) {
            try {
                const res = await fetch(`/api/ai/reports/${reportId}`);
                const data = await res.json();
                
                if (res.ok) {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'result-box';
                    resultDiv.innerHTML = `<h4>${data.target_name} - å®Œæ•´æŠ¥å‘Š</h4><pre>${JSON.stringify(data.report_content, null, 2)}</pre>`;
                    
                    // åœ¨å¼¹çª—æˆ–é¡µé¢åº•éƒ¨æ˜¾ç¤º
                    const modal = document.createElement('div');
                    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;';
                    modal.innerHTML = `
                        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 800px; max-height: 80vh; overflow: auto;">
                            ${resultDiv.outerHTML}
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="margin-top: 15px;">å…³é—­</button>
                        </div>
                    `;
                    modal.className = 'modal';
                    document.body.appendChild(modal);
                }
            } catch (e) {
                showAlert('æŸ¥çœ‹æŠ¥å‘Šå¤±è´¥', 'error');
            }
        }
        
        async function deleteReport(reportId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŠ¥å‘Šå—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`/api/ai/reports/${reportId}`, {method: 'DELETE'});
                if (res.ok) {
                    showAlert('æŠ¥å‘Šå·²åˆ é™¤');
                    loadReports();
                }
            } catch (e) {
                showAlert('åˆ é™¤å¤±è´¥', 'error');
            }
        }
    </script>
</body>
</html>
